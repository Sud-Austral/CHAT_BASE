<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Gen√©rico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== VARIABLES CSS ===== */
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #1565c0;
            --primary-light: #64b5f6;
            --secondary-color: #43a047;
            --accent-color: #ff7043;
            --background: #f5f7fa;
            --surface: #ffffff;
            --text-primary: #212121;
            --text-secondary: #757575;
            --divider: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 5px 15px rgba(0, 0, 0, 0.2);
            --radius: 12px;
            --font-size-base: 16px;
        }

        /* ===== ESTILOS GENERALES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            position: relative;
            overflow-x: hidden;
            font-size: var(--font-size-base);
        }

        /* Fondo animado */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="leaf" patternUnits="userSpaceOnUse" width="100" height="100"><g fill="rgba(255,255,255,0.1)"><path d="M50 10c20 0 30 15 30 40-5-20-15-30-30-30s-25 10-30 30c0-25 10-40 30-40z"/></g></pattern></defs><rect width="100%" height="100%" fill="url(%23leaf)"/></svg>') repeat;
            opacity: 0.1;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* ===== CONTENEDOR PRINCIPAL ===== */
        .container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: none;
            border: none;
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== CABECERA ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 5px;
            position: relative;
            z-index: 2;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
        }

        /* ===== CONTENEDOR DE CHAT ===== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            font-size: var(--font-size-base);
        }

        /* ===== MENSAJES ===== */
        .message {
            display: flex;
            margin-bottom: 5px;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            font-size: var(--font-size-base);
            line-height: 1.4;
            letter-spacing: 0.2px;
        }

        .message-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        .user-message .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-bottom-right-radius: 5px;
            position: relative;
        }

        .user-message .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
            border-radius: inherit;
            pointer-events: none;
        }

        .bot-message .message-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            color: var(--text-primary);
            border: 1px solid rgba(30, 136, 229, 0.1);
            border-bottom-left-radius: 5px;
        }

        /* ===== AVATARES ===== */
        .bot-avatar, .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .bot-avatar {
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
            margin-right: 10px;
        }

        .user-avatar {
            background: linear-gradient(135deg, var(--accent-color), #e64a19);
            margin-left: 10px;
        }

        .bot-avatar:hover, .user-avatar:hover {
            transform: scale(1.1);
        }

        .bot-avatar i, .user-avatar i {
            font-size: 16px;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            max-width: 85%;
        }

        .bot-message .message-wrapper {
            flex-direction: row;
        }

        .user-message .message-wrapper {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        /* ===== TIMESTAMP ===== */
        .timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
            opacity: 0.7;
        }

        .bot-message .timestamp {
            text-align: left;
        }

        /* ===== INDICADOR DE ESCRITURA ===== */
        .typing-indicator {
            display: none;
            padding: 8px 15px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 13px;
            animation: pulse 1.5s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 2px;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing-bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* ===== INDICADOR DE CARGA ===== */
        .loading-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(30, 136, 229, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ENTRADA DE USUARIO ===== */
        .input-container {
            display: flex;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--divider);
            gap: 10px;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid var(--divider);
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
            transform: translateY(-1px);
        }

        #user-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        /* ===== BOTONES ===== */
        #send-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
        }

        #send-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(30, 136, 229, 0.4);
        }

        #send-button:active {
            transform: scale(0.95);
        }

        #send-button i {
            transition: transform 0.3s ease;
        }

        #send-button:hover i {
            transform: rotate(15deg);
        }

        #send-button.rotating {
            animation: rotate 1.5s linear infinite;
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #clear-button {
            background: linear-gradient(135deg, var(--accent-color), #e64a19);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 112, 67, 0.3);
            margin-left: 5px;
        }

        #clear-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 112, 67, 0.4);
        }

        #clear-button:active {
            transform: scale(0.95);
        }

        #export-button {
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.3);
            margin-left: 5px;
        }

        #export-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(67, 160, 71, 0.4);
        }

        #export-button:active {
            transform: scale(0.95);
        }

        #dark-mode-toggle {
            background: linear-gradient(135deg, #424242, #212121);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66, 66, 66, 0.3);
            margin-left: 5px;
        }

        #dark-mode-toggle:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(66, 66, 66, 0.4);
        }

        #dark-mode-toggle:active {
            transform: scale(0.95);
        }

        /* ===== BOTONES DE VOZ ===== */
        #voice-button {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.4);
            margin-left: 5px;
            position: relative;
        }

        #voice-button:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
        }

        #voice-button:active {
            transform: scale(0.95);
        }

        #voice-button.listening {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: voice-pulse 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
        }

        @keyframes voice-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
                transform: scale(1);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(244, 67, 54, 0);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
                transform: scale(1);
            }
        }

        #voice-button.listening::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #f44336;
            border-radius: 50%;
            animation: voice-ring 2s infinite;
        }

        @keyframes voice-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        #voice-button i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        #voice-button:hover i {
            transform: scale(1.1);
        }

        .speak-button {
            position: absolute;
            top: 5px;
            right: 35px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--divider);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--primary-color);
            opacity: 0.8;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-content:hover .speak-button {
            opacity: 1;
            transform: scale(1.1);
        }

        .speak-button:hover {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .speak-button.speaking {
            background: var(--secondary-color);
            color: white;
            animation: speak-pulse 1.5s infinite;
            opacity: 1;
        }

        @keyframes speak-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(67, 160, 71, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(67, 160, 71, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(67, 160, 71, 0);
            }
        }

        /* ===== PREGUNTAS SUGERIDAS ===== */
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            margin-left: 46px;
        }

        .suggested-question {
            background: rgba(30, 136, 229, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            outline: none;
            text-align: center;
            flex: 1 1 calc(33% - 8px);
            min-width: 140px;
        }

        .suggested-question:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 136, 229, 0.2);
        }

        .suggested-question:active {
            transform: scale(0.95);
        }

        /* ===== FOOTER ===== */
        .footer {
            padding: 10px 15px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--divider);
        }

        /* ===== SCROLLBAR ===== */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        /* ===== EFECTOS DE ESCRITURA ===== */
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 18px;
            background-color: var(--primary-color);
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .bot-avatar.typing {
            animation: pulse-avatar 1.5s infinite;
        }
        
        @keyframes pulse-avatar {
            0% { box-shadow: 0 0 0 0 rgba(67, 160, 71, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(67, 160, 71, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 160, 71, 0); }
        }

        /* ===== ENLACES ===== */
        .bot-message .message-content a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px dotted transparent;
        }

        .bot-message .message-content a:hover {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-dark);
        }

        /* ===== BOT√ìN COPIAR ===== */
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .message-content:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background: var(--primary-color);
            color: white;
        }

        .copy-button.copied {
            background: var(--secondary-color);
            color: white;
        }

        /* ===== INDICADOR DE CARACTERES ===== */
        .char-counter {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
            margin-right: 10px;
        }

        /* ===== MODO OSCURO ===== */
        body.dark-mode {
            --background: #1a1a1a;
            --surface: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --divider: #404040;
        }
        
        body.dark-mode .container {
            background: rgba(45, 45, 45, 0.95);
        }
        
        body.dark-mode .chat-container {
            background: linear-gradient(to bottom, #2d2d2d, #1a1a1a);
        }
        
        body.dark-mode .bot-message .message-content {
            background: linear-gradient(135deg, #3d3d3d, #2d2d2d);
            border-color: rgba(30, 136, 229, 0.3);
        }
        
        body.dark-mode .input-container {
            background: rgba(45, 45, 45, 0.9);
        }
        
        body.dark-mode #user-input {
            background: #3d3d3d;
            color: white;
            border-color: #555;
        }
        
        body.dark-mode #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
        
        body.dark-mode .footer {
            background: rgba(45, 45, 45, 0.9);
        }
        
        body.dark-mode .suggested-question {
            background: rgba(30, 136, 229, 0.2);
            border-color: var(--primary-light);
            color: var(--primary-light);
        }
        
        body.dark-mode .suggested-question:hover {
            background: var(--primary-light);
            color: white;
        }
        
        body.dark-mode .copy-button {
            background: rgba(255, 255, 255, 0.2);
            color: #b0b0b0;
        }
        
        body.dark-mode .copy-button:hover {
            background: var(--primary-light);
            color: white;
        }

        /* ===== TOOLTIPS MEJORADOS ===== */
        button[title] {
            position: relative;
        }

        button[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            pointer-events: none;
        }

        button[title]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% - 5px);
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            pointer-events: none;
        }

        .copy-button[title]:hover::after,
        .speak-button[title]:hover::after {
            bottom: 120%;
            font-size: 11px;
        }

        .copy-button[title]:hover::before,
        .speak-button[title]:hover::before {
            bottom: calc(120% - 5px);
        }

        body.dark-mode button[title]:hover::after {
            background: rgba(255, 255, 255, 0.95);
            color: #212121;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode button[title]:hover::before {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        /* Asegurar que los tooltips sean visibles en modo oscuro */
        body.dark-mode .copy-button[title]:hover::after,
        body.dark-mode .speak-button[title]:hover::after {
            background: rgba(255, 255, 255, 0.95);
            color: #212121;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .copy-button[title]:hover::before,
        body.dark-mode .speak-button[title]:hover::before {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        /* ===== NOTIFICACIONES ===== */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-success {
            background-color: #4caf50;
            color: white;
        }

        .notification-error {
            background-color: #f44336;
            color: white;
        }

        .notification-warning {
            background-color: #ff9800;
            color: white;
        }

        .notification-info {
            background-color: #2196f3;
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
                max-width: none;
            }
            
            .header {
                padding: 12px 8px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .chat-container {
                padding: 10px;
            }
            
            .message-content {
                max-width: 85%;
                padding: 12px 15px;
                font-size: 15px;
            }
            
            .bot-avatar, .user-avatar {
                width: 32px;
                height: 32px;
            }
            
            .bot-avatar {
                margin-right: 8px;
            }
            
            .user-avatar {
                margin-left: 8px;
            }
            
            .input-container {
                padding: 10px 8px;
            }
            
            #user-input {
                padding: 10px 15px;
                font-size: 15px;
            }
            
            #send-button, #clear-button, #export-button, #dark-mode-toggle, #voice-button {
                width: 40px;
                height: 40px;
            }
            
            .suggested-questions {
                margin-left: 40px;
                flex-direction: column;
            }
            
            .suggested-question {
                flex: 1 1 100%;
                min-width: auto;
                font-size: 13px;
            }
            
            #voice-button {
                width: 44px;
                height: 44px;
            }
            
            #voice-button i {
                font-size: 18px;
            }
            
            .speak-button {
                width: 26px;
                height: 26px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                font-size: 11px;
            }
            
            .message-content {
                max-width: 90%;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .bot-avatar, .user-avatar {
                width: 28px;
                height: 28px;
            }
            
            #user-input {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            #send-button, #clear-button, #export-button, #dark-mode-toggle, #voice-button {
                width: 38px;
                height: 38px;
            }
            
            #voice-button {
                width: 42px;
                height: 42px;
            }
            
            #voice-button i {
                font-size: 17px;
            }
            
            .speak-button {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 700px;
                height: 80vh;
            }
            
            .message-content {
                max-width: 70%;
                font-size: 15px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }
            
            .message-content {
                font-size: 17px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 95vh;
            }
            
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                display: none;
            }
            
            .chat-container {
                padding: 8px;
            }
        }

        /* ===== ACCESIBILIDAD ===== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .bot-message .message-content h1,
        .bot-message .message-content h2,
        .bot-message .message-content h3 {
            margin: 8px 0;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .bot-message .message-content ul,
        .bot-message .message-content ol {
            margin: 8px 0 8px 20px;
        }

        .bot-message .message-content code {
            background: rgba(0,0,0,0.05);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        .bot-message .message-content pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-comments"></i> <span id="chat-title">Asistente Virtual</span></h1>
            <p id="chat-subtitle">Tu ayudante inteligente para responder preguntas</p>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="message bot-message">
                <div class="message-wrapper">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="message-content" id="welcome-message">
                            ¬°Hola! üëã Soy tu asistente virtual. Estoy aqu√≠ para ayudarte con cualquier pregunta que tengas. ¬øEn qu√© puedo asistirte hoy?
                        </div>
                        <div class="timestamp" id="initial-timestamp"></div>
                        <div class="suggested-questions" id="initial-questions">
                            <!-- Las preguntas se cargar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <i class="fas fa-robot"></i> El asistente est√° escribiendo<span>.</span><span>.</span><span>.</span>
        </div>
        <div class="loading-indicator" id="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Procesando tu solicitud...</p>
        </div>
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta aqu√≠..." aria-label="Escribe tu pregunta aqu√≠" />
            <div class="char-counter" id="char-counter">0/500</div>
            <button id="send-button" aria-label="Enviar mensaje" title="Enviar mensaje (Enter)">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button id="voice-button" aria-label="Grabar voz" title="Grabar voz">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="clear-button" aria-label="Limpiar chat" title="Limpiar chat (Ctrl+K)">
                <i class="fas fa-trash"></i>
            </button>
            <button id="export-button" aria-label="Exportar conversaci√≥n" title="Exportar conversaci√≥n (Ctrl+E)">
                <i class="fas fa-download"></i>
            </button>
            <button id="dark-mode-toggle" aria-label="Cambiar modo oscuro" title="Cambiar modo oscuro (Ctrl+D)">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        <div class="footer">
            <i class="fas fa-shield-alt"></i> <span id="footer-text">Asistente Virtual</span>¬© 2025
            <br>
            Este ChatBot puede cometer errores. Comprueba la informaci√≥n importante.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="pass.js"></script>
    <script src="delito.js"></script>
    <script src="localizacion.js"></script>
    <script src="tiempo.js"></script>
    <script src="metricas.js"></script>
    
    <script>
        function getNewTime(metrica){
            const tiempoAux = metrica["ID_Tiempo"]

            const tiempo2 = tiempo.find(x => x["ID_Tiempo (PK)"] == tiempoAux);
            metrica["ID_Tiempo"] = tiempo2["ID_Mes"] * 100 + tiempo2["Semana_del_A√±o"];
            metrica["ID_Tiempo"] = `T-${metrica["ID_Tiempo"]}`
            return metrica;
        }
        metricaArray = metricaArray.map(getNewTime)
        
        tiempo =  tiempo.map(obj => ({
                        ...obj,
                        "ID_Tiempo (PK)": `T-${obj.ID_Mes * 100 + obj["Semana_del_A√±o"]}` 
                        }));
    </script>
    
    <script>
        // Configuraci√≥n de la aplicaci√≥n
        const CHAT_CONFIG = {
            // Configuraci√≥n general
            MAX_HISTORY_LENGTH: 10,
            MAX_INPUT_LENGTH: 500,
            TYPING_SPEED: 3,
            DEBOUNCE_DELAY: 500,
            
            // Configuraci√≥n de la interfaz
            TITLE: "Asistente Virtual",
            SUBTITLE: "Tu ayudante inteligente para responder preguntas",
            WELCOME_MESSAGE: "¬°Hola! üëã Soy tu asistente virtual. Estoy aqu√≠ para ayudarte con cualquier pregunta que tengas. ¬øEn qu√© puedo asistirte hoy?",
            
            // Preguntas iniciales sugeridas
            INITIAL_QUESTIONS: [
                "AMENAZAS Y RI√ëAS en Antofagasta en Semana_del_A√±o 2 cual es el promedio (debe ser  2.71)",
                "¬øCu√°les son las principales diferencias entre las licencias Clase A (profesional), Clase B (no profesional) y Clase C (motocicletas), y con qu√© frecuencia deben renovarse sus titulares los requisitos de idoneidad?",
                "¬øQu√© infracciones se clasifican como grav√≠simas seg√∫n el Art. 197, y c√≥mo se determinan las multas y suspensiones de licencia acumuladas?"
            ],
            
            // Configuraci√≥n del bot
            BOT_NAME: "Asistente",
            BOT_ICON: "fas fa-robot",
            USER_ICON: "fas fa-user",
            
            // Configuraci√≥n de la API
            API_MODEL: "glm-4.5-flash",
            API_KEY: API_KEY,
            API_URL: API_URL,
            
            //${JSON.stringify(delito)} ${JSON.stringify(localizacion)} ${JSON.stringify(metrica)}
            // Configuraci√≥n del prompt
            PROMPT_PREFIX:`Eres un analista experto en inteligencia de datos criminales. 
            Tu tarea es analizar la consulta del usuario y devolver √öNICAMENTE un JSON con los par√°metros necesarios 
            para filtrar la lista llamada 'metrica'.

            Usa las siguientes bases de datos de referencia:

            üîπ Base 1 - Delitos:
            ${JSON.stringify(delito, null, 2)}

            üîπ Base 2 - Localizaciones:
            ${JSON.stringify(localizacion, null, 2)}

            üîπ Base 3 - Tiempos:
            ${JSON.stringify(tiempo, null, 2)}

            ‚ö†Ô∏è MUY IMPORTANTE:
            Para determinar el valor de "ID_Tiempo":
            1. Busca en la Base 3 - Tiempos el objeto que cumpla AMBAS condiciones:
            - "ID_A√±o" coincide exactamente con el a√±o mencionado.
            - "Semana_del_A√±o" coincide exactamente con el n√∫mero de semana mencionado.
            2. Usa el valor exacto de su campo "ID_Tiempo (PK)" como "ID_Tiempo".
            3. No calcules ni estimes el ID_Tiempo. No uses f√≥rmulas, no restes ni sumes 1.            
            4. No asumas que los ID son correlativos entre a√±os. El conteo contin√∫a de un a√±o a otro.
            5. Si hay varios candidatos (lo cual no deber√≠a ocurrir), elige el primero que cumpla ambas condiciones exactas.
            6. Las claves "ID_Tiempo (PK)" se forman con ID_Mes y Semana_del_A√±o, por ejemplo:
                 la semana 12 del 2024 = "T-20240312"
                 la semana 15 del 2023 = "T-20230415"
                 la semana 27 del 2025 = "T-20240727"
                 la semana 35 del 2025 = "T-20240835"
                 la semana 35 del 2024 = "T-20240835"
                 la semana 18 del 2024 = "T-20240418"
            7. Las claves "ID_Localizacion_Agg" se deben formar con las tabla Localizaciones teniendo en consideracion que
            existen comunas y regiones por ejemplo:
                la region de valparaiso = "R-05"
                la comuna de valparaiso = "C-5101"
                la region de metropolitana = "R-13"
                la comuna de maipu = "C-13119"
                la region de Magallanes = "R-12"
                la comuna de punta arenas = "C-12101"
                la La Granja = "C-13111"
                la √ëuble = "R-16"
            Importante, notar que podria no decir sin es comuna o region, ante la duda asumir region.

            El JSON final debe incluir solo los campos relevantes presentes en la estructura de la lista 'metrica':
            {
            "ID_Tiempo": number,
            "ID_Delito": number,
            "ID_Localizacion_Agg": string,
            }

            Tambi√©n puedes incluir el nombre de la m√©trica solicitada si se menciona expl√≠citamente en la consulta.
            Las m√©tricas disponibles son:
            'Frecuencia_Semana_Actual', 
            'Frecuencia_Semana_Anterior',
            'Frecuencia_Misma_Semana_AA',
            'Promedio_Diario_Semanal',
            'Media_Movil_4S',
            'Var_Vs_Semana_Anterior',
            'Var_Vs_Mis_Semana_AA',
            'Tendencia_Corto_Plazo',
            'Var%_vs_Semana_Anterior',
            'Var%_Vs_Mis_Semana_AA'

            üìò Ejemplo:
            Consulta: "¬øCu√°l es la frecuencia de Antofagasta para la semana 12 del 2024 de da√±os?"
            Salida esperada:
            {
            "ID_Tiempo": <valor exacto de 'ID_Tiempo (PK)' donde ID_A√±o=2024 y Semana_del_A√±o=12>,
            "ID_Delito": <ID del delito 'da√±os'>,
            "ID_Localizacion_Agg": "R-02",
            "metrica": "Frecuencia_Semana_Actual"
            }

            ‚ö†Ô∏è Responde solo con un JSON v√°lido, sin texto adicional, sin explicaciones, sin comillas triples ni etiquetas Markdown.
            `,

            // Configuraci√≥n del footer
            FOOTER_TEXT: "Asistente Virtual"
        };

        // Estado de la aplicaci√≥n
        const UIState = {
            historialConversacion: [],
            debounceTimer: null,
            darkMode: false,
            recognition: null,
            synthesis: window.speechSynthesis,
            currentUtterance: null
        };

        // Elementos del DOM
        const DOMElements = {
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            clearButton: document.getElementById('clear-button'),
            exportButton: document.getElementById('export-button'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            voiceButton: document.getElementById('voice-button'),
            typingIndicator: document.getElementById('typing-indicator'),
            loadingIndicator: document.getElementById('loading-indicator'),
            charCounter: document.getElementById('char-counter'),
            chatTitle: document.getElementById('chat-title'),
            chatSubtitle: document.getElementById('chat-subtitle'),
            welcomeMessage: document.getElementById('welcome-message'),
            footerText: document.getElementById('footer-text')
        };

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar la interfaz con las variables de configuraci√≥n
            setupInterface();
            
            // Configurar event listeners
            DOMElements.sendButton.addEventListener('click', sendMessage);
            DOMElements.clearButton.addEventListener('click', clearChat);
            DOMElements.exportButton.addEventListener('click', exportConversation);
            DOMElements.darkModeToggle.addEventListener('click', toggleDarkMode);
            DOMElements.voiceButton.addEventListener('click', toggleVoiceRecognition);
            
            // Event listeners para el input
            DOMElements.userInput.addEventListener('keypress', handleKeyPress);
            DOMElements.userInput.addEventListener('input', handleInput);
            DOMElements.userInput.addEventListener('touchstart', preventZoom);
            
            // Configurar preguntas iniciales
            setupInitialQuestions();
            
            // Cargar estado guardado
            loadAppState();
            
            // Enfocar el input
            DOMElements.userInput.focus();
            
            // Configurar atajos de teclado
            setupKeyboardShortcuts();
            
            // Manejar cambios de orientaci√≥n
            window.addEventListener('orientationchange', handleOrientationChange);
            
            // Inicializar reconocimiento de voz si est√° disponible
            initializeVoiceRecognition();
            
            // Verificar s√≠ntesis de voz
            if (!UIState.synthesis) {
                console.warn("La s√≠ntesis de voz no est√° disponible en este navegador.");
                DOMElements.voiceButton.style.display = 'none';
            }
        });

        /**
         * Configura la interfaz con las variables de configuraci√≥n
         */
        function setupInterface() {
            DOMElements.chatTitle.textContent = CHAT_CONFIG.TITLE;
            DOMElements.chatSubtitle.textContent = CHAT_CONFIG.SUBTITLE;
            DOMElements.welcomeMessage.textContent = CHAT_CONFIG.WELCOME_MESSAGE;
            DOMElements.footerText.textContent = CHAT_CONFIG.FOOTER_TEXT;
        }

        /**
         * Inicializa el reconocimiento de voz
         */
        function initializeVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn("El reconocimiento de voz no est√° disponible en este navegador.");
                DOMElements.voiceButton.style.display = 'none';
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            UIState.recognition = new SpeechRecognition();
            
            UIState.recognition.lang = 'es-ES';
            UIState.recognition.continuous = false;
            UIState.recognition.interimResults = false;
            UIState.recognition.maxAlternatives = 1;
            
            UIState.recognition.onstart = () => {
                DOMElements.voiceButton.classList.add('listening');
                DOMElements.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                DOMElements.userInput.placeholder = "Escuchando...";
            };
            
            UIState.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                DOMElements.userInput.value = transcript;
                updateCharCounter();
                sendMessage();
            };
            
            UIState.recognition.onerror = (event) => {
                console.error('Error en el reconocimiento de voz:', event.error);
                showNotification(`Error en el reconocimiento de voz: ${event.error}`, 'error');
                resetVoiceButton();
            };
            
            UIState.recognition.onend = () => {
                resetVoiceButton();
            };
        }

        /**
         * Restablece el bot√≥n de voz
         */
        function resetVoiceButton() {
            DOMElements.voiceButton.classList.remove('listening');
            DOMElements.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            DOMElements.userInput.placeholder = "Escribe tu pregunta aqu√≠...";
        }

        /**
         * Activa o desactiva el reconocimiento de voz
         */
        function toggleVoiceRecognition() {
            if (!UIState.recognition) {
                showNotification("El reconocimiento de voz no est√° disponible en este navegador.", 'warning');
                return;
            }
            
            if (DOMElements.voiceButton.classList.contains('listening')) {
                UIState.recognition.stop();
                showNotification("Grabaci√≥n detenida", 'info');
            } else {
                UIState.recognition.start();
                showNotification("Grabando... Habla ahora", 'info');
            }
        }

        /**
         * Lee un texto en voz alta
         * @param {string} text - Texto a leer
         * @param {HTMLElement} button - Bot√≥n que activ√≥ la acci√≥n
         */
        function speakText(text, button) {
            if (!UIState.synthesis) {
                showNotification("La s√≠ntesis de voz no est√° disponible en este navegador.", 'warning');
                return;
            }
            
            // Detener cualquier reproducci√≥n en curso
            if (UIState.synthesis.speaking) {
                UIState.synthesis.cancel();
                if (button) {
                    button.classList.remove('speaking');
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                return;
            }
            
            // Buscar una voz neutra en espa√±ol
            let voices = UIState.synthesis.getVoices();
            let spanishVoice = voices.find(voice => 
                voice.lang.includes('es') && 
                (voice.name.includes('Google') || voice.name.includes('Microsoft')) &&
                (voice.name.includes('Neural') || voice.name.includes('Standard'))
            );
            
            // Si no se encuentra una voz espec√≠fica, usar cualquier voz en espa√±ol
            if (!spanishVoice) {
                spanishVoice = voices.find(voice => voice.lang.includes('es'));
            }
            
            // Si a√∫n no hay voz en espa√±ol, usar la primera disponible
            if (!spanishVoice && voices.length > 0) {
                spanishVoice = voices[0];
            }
            
            // Crear el utterance
            UIState.currentUtterance = new SpeechSynthesisUtterance(text);
            UIState.currentUtterance.lang = 'es-ES';
            UIState.currentUtterance.rate = 1.0;
            UIState.currentUtterance.pitch = 1.0;
            UIState.currentUtterance.volume = 1.0;
            
            if (spanishVoice) {
                UIState.currentUtterance.voice = spanishVoice;
            }
            
            // Eventos del utterance
            UIState.currentUtterance.onstart = () => {
                if (button) {
                    button.classList.add('speaking');
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                }
                showNotification("Reproduciendo audio...", 'info');
            };

            UIState.currentUtterance.onend = () => {
                if (button) {
                    button.classList.remove('speaking');
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                showNotification("Reproducci√≥n finalizada", 'success');
            };
                        
            UIState.currentUtterance.onerror = (event) => {
                console.error('Error en la s√≠ntesis de voz:', event.error);
                if (button) {
                    button.classList.remove('speaking');
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                showNotification(`Voz detenida`, 'error');
            };
            
            // Iniciar la s√≠ntesis
            UIState.synthesis.speak(UIState.currentUtterance);
        }

        /**
         * Configura las preguntas iniciales sugeridas
         */
        function setupInitialQuestions() {
            const initialQuestionsContainer = document.getElementById('initial-questions');
            initialQuestionsContainer.innerHTML = '';
            
            CHAT_CONFIG.INITIAL_QUESTIONS.forEach(question => {
                const button = document.createElement('button');
                button.classList.add('suggested-question');
                button.textContent = question;
                button.addEventListener('click', () => {
                    DOMElements.userInput.value = question;
                    updateCharCounter();
                    sendMessage();
                });
                initialQuestionsContainer.appendChild(button);
            });
        }

        /**
         * Maneja el evento de presionar una tecla en el input
         * @param {KeyboardEvent} e - Evento de teclado
         */
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        /**
         * Maneja el evento de entrada en el input de texto
         */
        function handleInput() {
            updateCharCounter();
            
            // Implementar debounce para optimizar rendimiento
            clearTimeout(UIState.debounceTimer);
            UIState.debounceTimer = setTimeout(() => {
                // Aqu√≠ podr√≠as implementar autocompletado o sugerencias en tiempo real
            }, CHAT_CONFIG.DEBOUNCE_DELAY);
        }

        /**
         * Previene el zoom en iOS cuando se enfoca el input
         */
        function preventZoom() {
            DOMElements.userInput.style.fontSize = '16px';
        }

        /**
         * Actualiza el contador de caracteres
         */
        function updateCharCounter() {
            const currentLength = DOMElements.userInput.value.length;
            DOMElements.charCounter.textContent = `${currentLength}/${CHAT_CONFIG.MAX_INPUT_LENGTH}`;
            
            // Cambiar color si se acerca al l√≠mite
            if (currentLength > CHAT_CONFIG.MAX_INPUT_LENGTH * 0.9) {
                DOMElements.charCounter.style.color = 'var(--accent-color)';
            } else {
                DOMElements.charCounter.style.color = 'var(--text-secondary)';
            }
        }

        /**
         * Env√≠a un mensaje del usuario
         */
        async function sendMessage() {
            const message = DOMElements.userInput.value.trim();
            
            // Validar entrada
            if (message === '') {
                showNotification('Por favor, escribe una pregunta antes de enviar.', 'warning');
                return;
            }
            
            if (message.length > CHAT_CONFIG.MAX_INPUT_LENGTH) {
                showNotification(`Tu mensaje es demasiado largo. M√°ximo ${CHAT_CONFIG.MAX_INPUT_LENGTH} caracteres.`, 'error');
                return;
            }
            
            // Deshabilitar elementos durante el env√≠o
            setSendingState(true);
            
            // Agregar mensaje del usuario al chat
            addMessageToChat('user', message);
            DOMElements.userInput.value = '';
            updateCharCounter();
            
            // Mostrar indicador de carga
            DOMElements.loadingIndicator.classList.add('active');
            DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            
            try {
                // Obtener respuesta del bot
                const response = await obtenerRespuesta(message);
                
                // Ocultar indicador de carga
                DOMElements.loadingIndicator.classList.remove('active');
                
                // Agregar respuesta del bot al chat
                addMessageToChat('bot', response.respuesta, response.preguntas, true);
                
                // Guardar estado de la aplicaci√≥n
                saveAppState();
            } catch (error) {
                console.error("Error al enviar mensaje:", error);
                DOMElements.loadingIndicator.classList.remove('active');
                showNotification('Error al procesar tu solicitud. Por favor, intenta nuevamente.', 'error');
            } finally {
                // Rehabilitar elementos
                setSendingState(false);
                DOMElements.userInput.focus();
            }
        }

        /**
         * Establece el estado de env√≠o (deshabilita/habilita elementos)
         * @param {boolean} isSending - Indica si se est√° enviando un mensaje
         */
        function setSendingState(isSending) {
            DOMElements.sendButton.disabled = isSending;
            DOMElements.userInput.disabled = isSending;
            DOMElements.voiceButton.disabled = isSending;
            
            if (isSending) {
                DOMElements.sendButton.classList.add('rotating');
            } else {
                DOMElements.sendButton.classList.remove('rotating');
            }
        }

        /**
         * Agrega un mensaje al chat
         * @param {string} sender - Remitente del mensaje ('user' o 'bot')
         * @param {string} message - Contenido del mensaje
         * @param {Array} preguntas - Preguntas sugeridas (opcional)
         * @param {boolean} typewriterEffect - Si se aplica efecto de escritura
         */
        function addMessageToChat(sender, message, preguntas = [], typewriterEffect = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');

            // Crear avatar
            const avatar = document.createElement('div');
            avatar.classList.add(sender === 'user' ? 'user-avatar' : 'bot-avatar');
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            // Crear contenido del mensaje
            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');

            // Renderizar mensaje seg√∫n el remitente
            if (sender === 'bot') {
                // Mostrar Markdown correctamente formateado
                messageContent.innerHTML = formatMessage(message);

                // Bot√≥n de copiar
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-button');
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.addEventListener('click', () => copyToClipboard(message, copyButton));
                messageContent.appendChild(copyButton);
                
                // Bot√≥n de voz
                const speakButton = document.createElement('button');
                speakButton.classList.add('speak-button');
                speakButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakButton.addEventListener('click', () => speakText(message, speakButton));
                messageContent.appendChild(speakButton);
            } else {
                // Mostrar mensaje de usuario con efecto de escritura simple (sin HTML)
                messageContent.textContent = message;
            }

            // Crear timestamp
            const timestamp = document.createElement('div');
            timestamp.classList.add('timestamp');
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            timestamp.textContent = `Hoy, ${displayHours}:${minutes} ${period}`;

            // Armar estructura del mensaje
            const messageInfo = document.createElement('div');
            messageInfo.appendChild(messageContent);
            messageInfo.appendChild(timestamp);

            if (sender === 'user') {
                messageWrapper.appendChild(messageInfo);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(messageInfo);

                // Agregar preguntas sugeridas si existen
                if (preguntas.length > 0) {
                    const suggestedQuestions = document.createElement('div');
                    suggestedQuestions.classList.add('suggested-questions');

                    preguntas.forEach(question => {
                        const button = document.createElement('button');
                        button.classList.add('suggested-question');
                        button.textContent = question;
                        button.addEventListener('click', () => {
                            DOMElements.userInput.value = question;
                            updateCharCounter();
                            sendMessage();
                        });
                        suggestedQuestions.appendChild(button);
                    });

                    messageInfo.appendChild(suggestedQuestions);
                }
            }

            messageDiv.appendChild(messageWrapper);
            DOMElements.chatContainer.appendChild(messageDiv);

            // Desplazar suavemente al final
            setTimeout(() => {
                DOMElements.chatContainer.scrollTo({
                    top: DOMElements.chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        /**
         * Implementa el efecto de escritura progresiva con soporte para pesta√±as inactivas
         * @param {HTMLElement} element - Elemento donde se escribir√° el texto
         * @param {string} text - Texto a escribir
         * @param {number} index - √çndice actual
         * @param {number} speed - Velocidad de escritura
         * @param {Function} callback - Funci√≥n a ejecutar al finalizar
         */
        function typeWriter(element, text, index, speed, callback) {
            let startTime = Date.now();
            let lastActiveTime = Date.now();
            let isTabActive = !document.hidden;
            let timeoutId = null;
            let animationFrameId = null;
            
            // Manejar cambios de visibilidad de la pesta√±a
            const handleVisibilityChange = () => {
                const wasActive = isTabActive;
                isTabActive = !document.hidden;
                
                // Si la pesta√±a acaba de volver a estar activa, calcula cu√°nto tiempo estuvo inactiva
                if (!wasActive && isTabActive) {
                    const inactiveTime = Date.now() - lastActiveTime;
                    // Calcula cu√°ntos caracteres deber√≠an haberse mostrado durante ese tiempo
                    const charsToShow = Math.floor(inactiveTime / speed);
                    
                    // Si hay caracteres que mostrar, procesa varios a la vez
                    if (charsToShow > 0 && index < text.length) {
                        // Cancelar el timeout pendiente
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                            timeoutId = null;
                        }
                        
                        // Cancelar el animation frame pendiente
                        if (animationFrameId) {
                            cancelAnimationFrame(animationFrameId);
                            animationFrameId = null;
                        }
                        
                        // Procesar los caracteres acumulados
                        processMultipleChars(Math.min(charsToShow, text.length - index));
                        return;
                    }
                }
                
                // Actualiza el √∫ltimo tiempo activo
                if (isTabActive) {
                    lastActiveTime = Date.now();
                }
            };
            
            // Funci√≥n para procesar m√∫ltiples caracteres a la vez
            function processMultipleChars(count) {
                if (index >= text.length) {
                    finishTypewriter();
                    return;
                }
                
                // Procesar hasta 'count' caracteres
                for (let i = 0; i < count && index < text.length; i++) {
                    const currentContent = element.innerHTML.replace('<span class="typing-cursor"></span>', '');
                    element.innerHTML = currentContent + text.charAt(index) + '<span class="typing-cursor"></span>';
                    index++;
                }
                
                // Scroll al final
                DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
                
                // Si quedan caracteres, continuar con el siguiente paso
                if (index < text.length) {
                    startTime = Date.now();
                    scheduleNextChar();
                } else {
                    finishTypewriter();
                }
            }
            
            // Funci√≥n para programar el siguiente car√°cter
            function scheduleNextChar() {
                if (isTabActive) {
                    // Usar requestAnimationFrame para mejor rendimiento cuando la pesta√±a est√° activa
                    animationFrameId = requestAnimationFrame(() => {
                        const elapsed = Date.now() - startTime;
                        const remainingTime = Math.max(0, speed - elapsed);
                        
                        if (remainingTime <= 0) {
                            // Si ya pas√≥ el tiempo, mostrar el car√°cter inmediatamente
                            showNextChar();
                        } else {
                            // Programar un timeout para el tiempo restante
                            timeoutId = setTimeout(showNextChar, remainingTime);
                        }
                    });
                } else {
                    // Cuando la pesta√±a est√° inactiva, usar setTimeout directamente
                    timeoutId = setTimeout(showNextChar, speed);
                }
            }
            
            // Funci√≥n para mostrar el siguiente car√°cter
            function showNextChar() {
                if (index < text.length) {
                    // Obtener el contenido actual sin el cursor
                    const currentContent = element.innerHTML.replace('<span class="typing-cursor"></span>', '');
                    
                    // A√±adir el siguiente car√°cter
                    element.innerHTML = currentContent + text.charAt(index) + '<span class="typing-cursor"></span>';
                    
                    // Incrementar el √≠ndice
                    index++;
                    
                    // Scroll al final
                    DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
                    
                    // Reiniciar el tiempo de inicio para el siguiente car√°cter
                    startTime = Date.now();
                    
                    // Programar el siguiente car√°cter
                    scheduleNextChar();
                } else {
                    finishTypewriter();
                }
            }
            
            // Funci√≥n para finalizar el efecto de escritura
            function finishTypewriter() {
                // Eliminar el cursor
                const cursor = element.querySelector('.span.typing-cursor');
                if (cursor) {
                    cursor.remove();
                }
                
                // Eliminar el event listener
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                
                // Cancelar cualquier timeout o animation frame pendiente
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                // Ejecutar callback si existe
                if (callback) callback();
            }
            
            // A√±adir el event listener de visibilidad
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Iniciar el proceso de escritura
            scheduleNextChar();
        }

        /**
         * Formatea un mensaje con Markdown b√°sico
         * @param {string} message - Mensaje a formatear
         * @returns {string} Mensaje formateado
         */
        function formatMessage(message) {
            if (!message) return '';
            
            const sanitized = sanitizeInput(message);
            
            // Instalamos un renderer que maneja ambas firmas
            marked.use({
                renderer: {
                link: function(arg1, maybeTitle, maybeText) {
                    let href, title, text;

                    // Caso nuevo: un √∫nico token-objeto
                    if (typeof arg1 === 'object' && arg1 !== null && !('startsWith' in arg1)) {
                    // extraemos posibles campos (los nombres pueden variar seg√∫n la versi√≥n)
                    href  = arg1.href ?? arg1.url ?? arg1.destination ?? '';
                    title = arg1.title ?? '';
                    text  = arg1.text ?? arg1.raw ?? arg1.textRaw ?? '';
                    } else {
                    // Caso cl√°sico: (href, title, text)
                    href  = arg1 || '';
                    title = maybeTitle || '';
                    text  = maybeText || '';
                    }

                    const safeHref = sanitizeHref(href);
                    const titleAttr = title ? ` title="${String(title).replace(/"/g,'&quot;')}"` : '';
                    const display = text || safeHref;

                    return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer"${titleAttr}>${display}</a>`;
                }
                }
            });

            return marked.parse(sanitized, { breaks: true, gfm: true });
        }

        /**
         * Escapa caracteres especiales en HTML
         * @param {string} text - Texto a escapar
         * @returns {string} Texto escapado
         */
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        /**
         * Obtiene una respuesta de la API
         * @param {string} pregunta - Pregunta del usuario
         * @returns {Promise<Object>} Respuesta del bot
         */
        async function obtenerRespuesta(pregunta) {
            console.log("üöÄ Inicio obtenerRespuesta");
            const preguntaSanitizada = sanitizeInput(pregunta);

            UIState.historialConversacion.push({ role: "user", content: preguntaSanitizada });

            const historialReciente = UIState.historialConversacion.slice(-CHAT_CONFIG.MAX_HISTORY_LENGTH);

            const mensajesBase = historialReciente.map((msg, idx) => {
                if (idx === 0 && msg.role === "user") {
                    return {
                        role: "user",
                        content: `${CHAT_CONFIG.PROMPT_PREFIX}\n${msg.content}`
                    };
                }
                return msg;
            });

            const controller = new AbortController();
            const timeoutMs = 300000; // 5 minutos
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                // ====================================================
                // üß† 1Ô∏è‚É£ LLAMADA: Obtener par√°metros de filtrado
                // ====================================================
                const reqParams = {
                    model: CHAT_CONFIG.API_MODEL,
                    messages: [
                        ...mensajesBase,
                        {
                            role: "system",
                            content: `
                                Eres un asistente que analiza una pregunta y determina los par√°metros exactos de filtrado
                                para un conjunto de datos. Tu √∫nica salida debe ser un JSON v√°lido, sin explicaciones.

                                Ejemplo de salida JSON:
                                {
                                "ID_Delito": 1,
                                "ID_Localizacion_Agg": "R-02",
                                "ID_Tiempo": "T-20240310",
                                "metrica": "Frecuencia_Semana_Anterior"
                                }

                                Responde SOLO con el objeto JSON (sin comentarios, texto ni etiquetas).
                            `.trim()
                        }
                    ],
                    //temperature: 0.1
                    temperature: .1
                };

                const resParams = await fetch(CHAT_CONFIG.API_URL, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${CHAT_CONFIG.API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(reqParams),
                    signal: controller.signal
                });

                if (!resParams.ok) throw new Error(`Error ${resParams.status}: ${resParams.statusText}`);

                const dataParams = await resParams.json();
                const textoParams = dataParams?.choices?.[0]?.message?.content?.trim();
                if (!textoParams) throw new Error("No se obtuvo respuesta v√°lida para los par√°metros.");

                let parametros = {};
                try {
                    // Parseo seguro de JSON incluso si viene con texto adicional
                    const match = textoParams.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("No se encontr√≥ un objeto JSON v√°lido.");
                    parametros = JSON.parse(match[0]);
                } catch (err) {
                    throw new Error("Error al parsear JSON de par√°metros: " + err.message);
                }
                //return 
                //return {JSON.stringify({parametros}, null, 2), preguntas, parametros, datosFiltrados }

                console.log("‚úÖ Par√°metros detectados:", parametros);
                return
                
                const metrica = parametros.metrica;
                delete parametros.metrica;

                // ====================================================
                // üßÆ 2Ô∏è‚É£ FILTRAR datos
                // ====================================================
                console.log("Antes",new Date())
                const datosFiltrados = metricaArray.filter(item =>
                    Object.entries(parametros).every(([key, value]) => item[key] === value)
                );
                console.log("Despues",new Date())
                if (!datosFiltrados.length) {
                    throw new Error("No se encontraron datos con los par√°metros generados.");
                }

                const answer = datosFiltrados[0][metrica];
                console.log("üìä Dato seleccionado:", answer);

                // ====================================================
                // üí¨ 3Ô∏è‚É£ LLAMADA: Generar respuesta final
                // ====================================================
                const promptConDatos = `
                    [INSTRUCCIONES]
                    Usa el valor obtenido para generar una respuesta clara y contextual a la pregunta del usuario.
                    Debes responder de manera natural pero concisa, utilizando el valor entregado como base. 
                    Si hay un historial en la conversaci√≥n agrega un peque√±o analisis considerando 
                    siempre los datos filtrados de la secci√≥n[DATOS_FILTRADOS] [/DATOS_FILTRADOS] y luego el contexto del historial.
                    [/INSTRUCCIONES]

                    [DATOS_FILTRADOS]
                    ${JSON.stringify({ parametros, metrica, answer,datosFiltrados }, null, 2)}
                    [/DATOS_FILTRADOS]

                    [PREGUNTA_ORIGINAL]
                    ${preguntaSanitizada}
                    [/PREGUNTA_ORIGINAL]

                    Genera tu respuesta con este formato exacto:
                    [RESPUESTA]Texto de la respuesta...[/RESPUESTA]
                    [PREGUNTAS]
                    1. Pregunta relacionada 1
                    2. Pregunta relacionada 2
                    3. Pregunta relacionada 3
                    [/PREGUNTAS]
                `.trim();

                const reqRespuesta = {
                    model: CHAT_CONFIG.API_MODEL,
                    messages: [
                        ...mensajesBase,
                        { role: "user", content: promptConDatos }
                    ],
                    temperature: 0.7
                };

                const resFinal = await fetch(CHAT_CONFIG.API_URL, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${CHAT_CONFIG.API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(reqRespuesta),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!resFinal.ok) throw new Error(`Error ${resFinal.status}: ${resFinal.statusText}`);

                const dataFinal = await resFinal.json();
                const respuestaCompleta = dataFinal?.choices?.[0]?.message?.content?.trim();
                if (!respuestaCompleta) throw new Error("No se obtuvo respuesta de la segunda llamada.");

                // ====================================================
                // üßæ 4Ô∏è‚É£ EXTRAER respuesta y preguntas
                // ====================================================
                const matchResp = respuestaCompleta.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
                const matchPreg = respuestaCompleta.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);

                const respuesta = matchResp ? matchResp[1].trim() : respuestaCompleta;
                let preguntas = [];

                if (matchPreg?.[1]) {
                    preguntas = matchPreg[1]
                        .split('\n')
                        .map(l => l.trim().replace(/^\d+\.\s*/, ''))
                        .filter(l => l && l.length > 3);
                }

                const genericas = CHAT_CONFIG.INITIAL_QUESTIONS;
                while (preguntas.length < 3) preguntas.push(genericas[preguntas.length]);

                UIState.historialConversacion.push({
                    role: "assistant",
                    content: respuesta
                });

                console.log("‚úÖ Finalizado correctamente");

                return { respuesta, preguntas, parametros, datosFiltrados };

            } catch (error) {
                clearTimeout(timeoutId);
                console.error("‚ùå Error en obtenerRespuesta:", error);
                if (error.name === "AbortError") {
                    throw new Error("Tiempo de espera excedido. Intenta nuevamente.");
                }
                throw error;
            }
        }

        /**
         * Sanitiza la entrada del usuario para prevenir ataques XSS
         * @param {string} input - Entrada del usuario
         * @returns {string} Entrada sanitizada
         */
        function sanitizeInput(input) {
            return input
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/on\w+\s*=/gi, '');
        }

        /**
         * Sanitiza una URL para prevenir ataques XSS
         * @param {string} url - URL a sanitizar
         * @returns {string} URL sanitizada
         */
        function sanitizeHref(url) {
            if (!url) return '#';
            const s = String(url).trim();
            if (/^\s*javascript:/i.test(s)) return '#';
            return s.replace(/"/g, '&quot;');
        }

        /**
         * Limpia el chat
         */
        function clearChat() {
            // Confirmar antes de limpiar
            if (!confirm('¬øEst√°s seguro de que quieres limpiar la conversaci√≥n?')) {
                return;
            }
            
            // Limpiar el contenedor de chat excepto el mensaje inicial
            const messages = DOMElements.chatContainer.querySelectorAll('.message');
            for (let i = 1; i < messages.length; i++) {
                messages[i].remove();
            }
            
            // Limpiar el historial
            UIState.historialConversacion = [];
            
            // Limpiar el almacenamiento local
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('darkMode');
            
            // Mostrar notificaci√≥n
            showNotification('Conversaci√≥n limpiada correctamente', 'success');
            
            // Enfocar el input
            DOMElements.userInput.focus();
        }

        /**
         * Exporta la conversaci√≥n a un archivo de texto
         */
        function exportConversation() {
            try {
                // Recopilar todos los mensajes
                const messages = DOMElements.chatContainer.querySelectorAll('.message');
                let conversationText = `Conversaci√≥n con ${CHAT_CONFIG.TITLE}\n`;
                conversationText += "================================================\n\n";
                
                messages.forEach(message => {
                    const isUser = message.classList.contains('user-message');
                    const messageContent = message.querySelector('.message-content').textContent;
                    const timestamp = message.querySelector('.timestamp').textContent;
                    
                    conversationText += `${isUser ? 'Usuario' : 'Asistente'} (${timestamp}):\n`;
                    conversationText += `${messageContent}\n\n`;
                });
                
                // Crear un blob con el texto
                const blob = new Blob([conversationText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // Crear un enlace para descargar el archivo
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversacion_${CHAT_CONFIG.TITLE.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                
                // Limpiar
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Mostrar notificaci√≥n
                showNotification('Conversaci√≥n exportada correctamente', 'success');
            } catch (error) {
                console.error("Error al exportar la conversaci√≥n:", error);
                showNotification('Error al exportar la conversaci√≥n', 'error');
            }
        }

        /**
         * Alterna el modo oscuro
         */
        function toggleDarkMode() {
            UIState.darkMode = !UIState.darkMode;
            
            if (UIState.darkMode) {
                document.body.classList.add('dark-mode');
                DOMElements.darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                DOMElements.darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            // Guardar preferencia
            localStorage.setItem('darkMode', UIState.darkMode);
        }

        /**
         * Copia el texto al portapapeles
         * @param {string} text - Texto a copiar
         * @param {HTMLElement} button - Bot√≥n que activ√≥ la acci√≥n
         */
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Cambiar el icono del bot√≥n temporalmente
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('copied');
                
                // Mostrar notificaci√≥n
                showNotification('Texto copiado al portapapeles', 'success');
                
                // Restaurar el icono despu√©s de 2 segundos
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                    button.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error("Error al copiar al portapapeles:", error);
                showNotification('Error al copiar al portapapeles', 'error');
            }
        }

        /**
         * Muestra una notificaci√≥n al usuario
         * @param {string} message - Mensaje a mostrar
         * @param {string} type - Tipo de notificaci√≥n ('success', 'error', 'warning', 'info')
         */
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.classList.add(`notification-${type}`);
            
            // A√±adir icono seg√∫n el tipo
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            
            notification.innerHTML = `${icon} ${message}`;
            
            // A√±adir al DOM
            document.body.appendChild(notification);
            
            // Eliminar despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        /**
         * Guarda el estado de la aplicaci√≥n en el almacenamiento local
         */
        function saveAppState() {
            try {
                // Guardar historial de conversaci√≥n
                localStorage.setItem('chatHistory', JSON.stringify(UIState.historialConversacion));
                
                // Guardar preferencia de modo oscuro
                localStorage.setItem('darkMode', UIState.darkMode);
            } catch (error) {
                console.error("Error al guardar el estado de la aplicaci√≥n:", error);
            }
        }

        /**
         * Carga el estado de la aplicaci√≥n desde el almacenamiento local
         */
        function loadAppState() {
            try {
                // Cargar preferencia de modo oscuro
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode !== null) {
                    UIState.darkMode = savedDarkMode === 'true';
                    if (UIState.darkMode) {
                        document.body.classList.add('dark-mode');
                        DOMElements.darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Cargar historial de conversaci√≥n (opcional, deshabilitado por defecto)
                // const savedHistory = localStorage.getItem('chatHistory');
                // if (savedHistory) {
                //     UIState.historialConversacion = JSON.parse(savedHistory);
                // }
            } catch (error) {
                console.error("Error al cargar el estado de la aplicaci√≥n:", error);
            }
        }

        /**
         * Configura los atajos de teclado
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K para limpiar el chat
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    clearChat();
                }
                
                // Ctrl/Cmd + E para exportar la conversaci√≥n
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportConversation();
                }
                
                // Ctrl/Cmd + D para alternar modo oscuro
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    toggleDarkMode();
                }
            });
        }

        /**
         * Maneja los cambios de orientaci√≥n del dispositivo
         */
        function handleOrientationChange() {
            setTimeout(() => {
                DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            }, 300);
        }
        
        /**
         * Establece la hora actual en el mensaje inicial del bot
         */
        function setInitialTimestamp() {
            const timestampEl = document.getElementById('initial-timestamp');
            if (timestampEl) {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                timestampEl.textContent = `Hoy, ${displayHours}:${minutes} ${period}`;
            }
        }

        // Llamar a la funci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', setInitialTimestamp);
    </script>
</body>
</html>