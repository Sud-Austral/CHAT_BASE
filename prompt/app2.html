<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Prompts IA</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts para una tipografía limpia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para mejorar la apariencia */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Variables de color para temas */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border-color: #d1d5db;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --gradient-start: #3b82f6;
            --gradient-end: #a855f7;
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-blue: #60a5fa;
            --accent-purple: #c084fc;
            --accent-green: #34d399;
            --accent-red: #f87171;
            --accent-yellow: #fbbf24;
            --card-bg: #1f2937;
            --input-bg: #374151;
            --gradient-start: #60a5fa;
            --gradient-end: #c084fc;
        }
        
        [data-theme="ocean"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #475569;
            --accent-blue: #38bdf8;
            --accent-purple: #a78bfa;
            --accent-green: #2dd4bf;
            --accent-red: #f472b6;
            --accent-yellow: #fcd34d;
            --card-bg: #1e293b;
            --input-bg: #334155;
            --gradient-start: #38bdf8;
            --gradient-end: #a78bfa;
        }
        
        [data-theme="forest"] {
            --bg-primary: #052e16;
            --bg-secondary: #14532d;
            --bg-tertiary: #166534;
            --text-primary: #dcfce7;
            --text-secondary: #bbf7d0;
            --text-tertiary: #86efac;
            --border-color: #22c55e;
            --accent-blue: #22d3ee;
            --accent-purple: #c084fc;
            --accent-green: #4ade80;
            --accent-red: #fb7185;
            --accent-yellow: #fde047;
            --card-bg: #14532d;
            --input-bg: #166534;
            --gradient-start: #22d3ee;
            --gradient-end: #c084fc;
        }
        
        /* Aplicar variables de color */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .bg-secondary {
            background-color: var(--bg-secondary);
        }
        
        .bg-tertiary {
            background-color: var(--bg-tertiary);
        }
        
        .bg-card {
            background-color: var(--card-bg);
        }
        
        .bg-input {
            background-color: var(--input-bg);
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .text-tertiary {
            color: var(--text-tertiary);
        }
        
        .border-custom {
            border-color: var(--border-color);
        }
        
        /* Gradiente para todos los temas */
        .gradient-text {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Transición suave para la lista del historial */
        #savedPromptsList > div {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        /* Estilos para las etiquetas */
        .tag-pill {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        /* Estilos para el resaltado de sintaxis */
        .prompt-header {
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .prompt-content {
            color: var(--text-secondary);
        }
        
        .prompt-list-item {
            color: var(--text-tertiary);
            margin-right: 0.5rem;
        }
        
        /* Estilos para los botones de tema */
        .theme-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-btn:hover {
            transform: scale(1.05);
            border-color: var(--accent-blue);
        }
        
        .theme-btn.active {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* Animación de cambio de tema */
        @keyframes themeChange {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .theme-changing {
            animation: themeChange 0.3s ease;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        /* Estilos para el selector de plantillas */
        .template-dropdown {
            position: relative;
        }
        
        .template-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            max-height: 400px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .template-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .template-item:last-child {
            border-bottom: none;
        }
        
        .template-item:hover {
            background-color: var(--bg-tertiary);
        }
        
        .template-category {
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 1rem;
            background-color: var(--bg-tertiary);
        }

        /* Estilos para el análisis de IA */
        .analysis-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }

        .score-excellent { color: var(--accent-green); }
        .score-good { color: var(--accent-yellow); }
        .score-needs-improvement { color: var(--accent-red); }

        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background-color: var(--bg-tertiary);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--bg-tertiary);
        }

        .suggestion-icon {
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .keyword-chip {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: var(--accent-blue);
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin: 0.25rem;
            transition: transform 0.2s;
        }

        .keyword-chip:hover {
            transform: scale(1.05);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .analysis-visible {
            animation: slideDown 0.3s ease-out;
        }

        /* Estilos para búsqueda avanzada */
        .search-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .filter-chip {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .filter-chip:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }

        .filter-chip.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .date-range-inputs {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .saved-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .saved-search-item:hover {
            background: var(--bg-secondary);
        }

        .saved-search-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .saved-search-query {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .search-result-highlight {
            background-color: rgba(251, 191, 36, 0.3);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .similarity-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--accent-purple);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .search-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
        }

        .search-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .search-tab {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-tab:hover {
            color: var(--text-primary);
        }

        .search-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Estilos para el sistema de etiquetas mejorado */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            min-height: 2.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--input-bg);
            transition: border-color 0.2s;
        }

        .tags-container:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .tag-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tag-chip.editing {
            background: var(--accent-purple);
        }

        .tag-chip.suggested {
            background: var(--accent-green);
            opacity: 0.8;
        }

        .tag-chip.suggested:hover {
            opacity: 1;
        }

        .tag-chip.manual {
            background: var(--accent-yellow);
        }

        .tag-remove {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 0.25rem;
        }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .tag-input {
            flex: 1;
            min-width: 120px;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 0.875rem;
            padding: 0.25rem;
        }

        .tag-input::placeholder {
            color: var(--text-tertiary);
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .tag-suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .tag-suggestion-item:hover {
            background-color: var(--bg-tertiary);
        }

        .tag-suggestion-item.selected {
            background-color: var(--accent-blue);
            color: white;
        }

        .extract-tags-btn {
            padding: 0.375rem 0.75rem;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .extract-tags-btn:hover {
            background: var(--accent-green);
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .extract-tags-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tag-type-indicator {
            font-size: 0.625rem;
            opacity: 0.7;
            margin-left: 0.25rem;
        }

        /* MEJORAS VISUALES PARA LOS PROMPTS GUARDADOS */
        .prompt-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .prompt-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .prompt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--accent-blue);
        }

        .prompt-card:hover::before {
            opacity: 1;
        }

        .prompt-header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .prompt-meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .prompt-date {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .prompt-usage {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .prompt-usage.used {
            color: var(--accent-green);
        }

        .prompt-actions {
            display: flex;
            gap: 0.5rem;
        }

        .prompt-action-btn {
            padding: 0.375rem 0.625rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .prompt-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .prompt-action-btn.copy:hover {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        .prompt-action-btn.delete:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
        }

        .prompt-content-section {
            margin-bottom: 1rem;
        }

        /* NUEVO FORMATO PARA EL TEXTO DEL PROMPT */
        .prompt-text {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
        }

        .prompt-section {
            padding: 1rem 1.25rem;
            position: relative;
            border-bottom: 1px solid rgba(var(--border-color), 0.3);
        }

        .prompt-section:last-child {
            border-bottom: none;
        }

        .prompt-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .prompt-section-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .icon-rol {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .icon-contexto {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .icon-tarea {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .icon-formato {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .icon-restricciones {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .prompt-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin: 0;
        }

        .prompt-section-content {
            padding-left: 2.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .prompt-section-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .restriction-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(var(--bg-primary), 0.5);
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent-blue);
        }

        .restriction-item:last-child {
            margin-bottom: 0;
        }

        .restriction-bullet {
            color: var(--accent-blue);
            font-weight: bold;
            margin-top: 0.125rem;
        }

        .restriction-text {
            flex: 1;
            color: var(--text-secondary);
        }

        .prompt-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .prompt-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            flex: 1;
        }

        .prompt-tag {
            padding: 0.25rem 0.625rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .prompt-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
        }

        .prompt-tag:hover::before {
            left: 100%;
        }

        .prompt-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .prompt-badges {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .prompt-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge-similarity {
            background: var(--accent-purple);
            color: white;
        }

        .badge-semantic {
            background: var(--accent-green);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state-description {
            font-size: 0.875rem;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Animación de entrada para las tarjetas */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prompt-card {
            animation: slideInUp 0.4s ease-out;
        }

        .prompt-card:nth-child(1) { animation-delay: 0.05s; }
        .prompt-card:nth-child(2) { animation-delay: 0.1s; }
        .prompt-card:nth-child(3) { animation-delay: 0.15s; }
        .prompt-card:nth-child(4) { animation-delay: 0.2s; }
        .prompt-card:nth-child(5) { animation-delay: 0.25s; }

        /* Efecto de brillo al hover */
        .prompt-card:hover .prompt-text {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
        }

        /* Indicador de calidad */
        .quality-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .quality-high {
            background: var(--accent-green);
        }

        .quality-medium {
            background: var(--accent-yellow);
        }

        .quality-low {
            background: var(--accent-red);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 currentColor;
            }
            70% {
                box-shadow: 0 0 0 6px rgba(255, 255, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }

        /* Resaltado de búsqueda mejorado */
        .search-result-highlight {
            background: linear-gradient(120deg, rgba(251, 191, 36, 0.3) 0%, rgba(251, 191, 36, 0.5) 100%);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(251, 191, 36, 0.2);
        }
    </style>
</head>

<body data-theme="light">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <!-- Encabezado de la aplicación -->
        <header class="text-center mb-10 relative">
            <!-- Selector de temas -->
            <div class="absolute top-0 right-0 flex gap-2">
                <button class="theme-btn active" data-theme="light" title="Tema Claro">
                    <svg class="w-6 h-6" style="color: #fbbf24" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button class="theme-btn" data-theme="dark" title="Tema Oscuro">
                    <svg class="w-6 h-6" style="color: #9ca3af" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
                <button class="theme-btn" data-theme="ocean" title="Tema Océano">
                    <svg class="w-6 h-6" style="color: #0ea5e9" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button class="theme-btn" data-theme="forest" title="Tema Bosque">
                    <svg class="w-6 h-6" style="color: #22c55e" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <h1 class="text-4xl md:text-5xl font-bold gradient-text">Generador de Prompts IA</h1>
            <p class="mt-3 text-lg text-secondary max-w-2xl mx-auto">Crea prompts efectivos y estructurados para cualquier modelo de IA. Selecciona una plantilla o define tus propios parámetros.</p>
        </header>

        <!-- Contenedor principal con dos columnas -->
        <main class="grid md:grid-cols-2 gap-8 max-w-7xl mx-auto">

            <!-- Columna 1: Formulario de Entradas -->
            <div class="bg-secondary p-6 rounded-2xl shadow-2xl border border-custom">
                <h2 class="text-2xl font-semibold mb-6 text-secondary">1. Define los Parámetros</h2>
                
                <!-- Selector de Plantillas -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-secondary">Plantillas Predefinidas</label>
                    <div class="template-dropdown">
                        <button id="templateToggle" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary text-left flex items-center justify-between hover:bg-tertiary transition">
                            <span id="selectedTemplate" class="text-tertiary">Selecciona una plantilla...</span>
                            <svg class="w-5 h-5 text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="templateMenu" class="template-menu hidden">
                            <!-- Las plantillas se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="space-y-5">
                    <!-- Campos del formulario... -->
                    <div>
                        <label for="rol" class="block mb-2 text-sm font-medium text-secondary">Rol (Persona)</label>
                        <input type="text" id="rol" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ej: Experto en marketing, programador, resumidor...">
                    </div>
                    <div>
                        <label for="contexto" class="block mb-2 text-sm font-medium text-secondary">Contexto</label>
                        <textarea id="contexto" rows="4" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ej: Estás preparando un informe para un cliente no técnico sobre las vulnerabilidades de su red."></textarea>
                    </div>
                    <div>
                        <label for="tarea" class="block mb-2 text-sm font-medium text-secondary">Tarea Específica</label>
                        <input type="text" id="tarea" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ej: Analizar y explicar los 3 riesgos más críticos.">
                    </div>
                    <div>
                        <label for="formato" class="block mb-2 text-sm font-medium text-secondary">Formato de Salida</label>
                        <input type="text" id="formato" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ej: Una lista numerada con un párrafo explicativo por punto.">
                    </div>
                    <div>
                        <label for="restricciones" class="block mb-2 text-sm font-medium text-secondary">Restricciones y Reglas</label>
                        <textarea id="restricciones" rows="3" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Ej: Tono claro y sencillo, sin jerga técnica. No exceder las 300 palabras."></textarea>
                    </div>
                    <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105 shadow-lg" disabled>
                        Generación Automática
                    </button>
                </div>
            </div>

            <!-- Columna 2: Salida del Prompt Generado -->
            <div class="bg-secondary p-6 rounded-2xl shadow-2xl border border-custom flex flex-col">
                <h2 class="text-2xl font-semibold mb-6 text-secondary">2. Prompt Resultante</h2>
                <div class="relative flex-grow">
                    <div id="outputPrompt" class="w-full h-full bg-tertiary border border-custom rounded-lg p-4 whitespace-pre-wrap overflow-y-auto text-secondary transition-colors duration-300 font-mono text-sm">El prompt generado aparecerá aquí...</div>
                </div>

                <!-- Sección de Análisis IA -->
                <div id="analysisResults" class="analysis-card hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-primary mb-1">Análisis de Calidad</h3>
                            <div class="flex items-baseline gap-3">
                                <span id="scoreValue" class="score-display">0</span>
                                <span id="scoreLabel" class="text-lg font-medium text-secondary">--</span>
                            </div>
                        </div>
                        <button id="closeAnalysis" class="text-tertiary hover:text-primary transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="progress-bar mb-6">
                        <div id="progressFill" class="progress-fill bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style="width: 0%"></div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-medium text-primary mb-3">Sugerencias de Mejora</h4>
                        <div id="suggestionsList" class="space-y-2">
                            <!-- Las sugerencias se generarán dinámicamente -->
                        </div>
                    </div>

                    <div>
                        <h4 class="font-medium text-primary mb-3">Palabras Clave Recomendadas</h4>
                        <div id="keywordsList" class="flex flex-wrap">
                            <!-- Las palabras clave se generarán dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Sistema de Etiquetas Mejorado -->
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-secondary">Etiquetas Inteligentes</label>
                        <button id="extractTagsBtn" class="extract-tags-btn" disabled>
                            🏷️ Extraer del Prompt
                        </button>
                    </div>
                    <div class="relative">
                        <div id="tagsContainer" class="tags-container">
                            <input type="text" id="tagInput" class="tag-input" placeholder="Añadir etiquetas...">
                        </div>
                        <div id="tagSuggestions" class="tag-suggestions hidden">
                            <!-- Las sugerencias se generarán dinámicamente -->
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex flex-col sm:flex-row gap-3">
                    <button id="analyzeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Analizar Prompt</span>
                    </button>
                    <button id="saveBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        <span>Guardar Prompt</span>
                    </button>
                    <button id="copyBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        <span>Copiar Prompt</span>
                    </button>
                </div>
                <p id="feedback" class="text-center text-sm mt-2 h-5 opacity-0 transition-opacity duration-300"></p>
            </div>
        </main>

        <section class="max-w-7xl mx-auto mt-16">
            <h2 class="text-3xl font-bold text-center mb-8 gradient-text">Historial de Prompts Guardados</h2>
            
            <!-- Panel de Búsqueda Avanzada -->
            <div class="search-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-primary">Búsqueda Avanzada</h3>
                    <button id="toggleAdvancedSearch" class="text-sm text-accent-blue hover:text-accent-purple transition">
                        <span id="toggleText">Mostrar filtros</span>
                        <svg id="toggleIcon" class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Pestañas de búsqueda -->
                <div class="search-tabs">
                    <button class="search-tab active" data-tab="basic">Básica</button>
                    <button class="search-tab" data-tab="semantic">Semántica</button>
                    <button class="search-tab" data-tab="similarity">Similitud</button>
                    <button class="search-tab" data-tab="saved">Guardadas</button>
                </div>

                <!-- Contenido de las pestañas -->
                <div id="searchTabContent">
                    <!-- Búsqueda Básica -->
                    <div id="basicSearch" class="tab-content">
                        <div class="mb-4">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-tertiary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <input id="searchInput" type="text" class="bg-input border border-custom text-primary text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 placeholder:text-tertiary" placeholder="Buscar prompts...">
                            </div>
                        </div>

                        <div id="advancedFilters" class="hidden space-y-4">
                            <!-- Filtro por etiquetas -->
                            <div class="filter-group">
                                <label class="filter-label">Filtrar por etiquetas</label>
                                <div id="tagFilters" class="flex flex-wrap">
                                    <!-- Las etiquetas se generarán dinámicamente -->
                                </div>
                            </div>

                            <!-- Filtro por fecha -->
                            <div class="filter-group">
                                <label class="filter-label">Rango de fechas</label>
                                <div class="date-range-inputs">
                                    <input type="date" id="dateFrom" class="date-input">
                                    <span class="text-tertiary">hasta</span>
                                    <input type="date" id="dateTo" class="date-input">
                                </div>
                            </div>

                            <!-- Filtro por frecuencia de uso -->
                            <div class="filter-group">
                                <label class="filter-label">Frecuencia de uso</label>
                                <div class="flex flex-wrap">
                                    <span class="filter-chip" data-usage="all">Todos</span>
                                    <span class="filter-chip" data-usage="frequent">Frecuentes</span>
                                    <span class="filter-chip" data-usage="recent">Recientes</span>
                                    <span class="filter-chip" data-usage="never">Sin usar</span>
                                </div>
                            </div>

                            <!-- Filtro por calidad -->
                            <div class="filter-group">
                                <label class="filter-label">Calidad estimada</label>
                                <div class="flex flex-wrap">
                                    <span class="filter-chip" data-quality="all">Todos</span>
                                    <span class="filter-chip" data-quality="excellent">Excelente (80+)</span>
                                    <span class="filter-chip" data-quality="good">Buena (60-79)</span>
                                    <span class="filter-chip" data-quality="needs-improvement">Mejorable (<60)</span>
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="flex gap-2">
                                <button id="saveSearchBtn" class="px-4 py-2 bg-accent-blue text-white rounded-lg hover:bg-accent-purple transition text-sm">
                                    Guardar búsqueda
                                </button>
                                <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                                    Limpiar filtros
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Búsqueda Semántica -->
                    <div id="semanticSearch" class="tab-content hidden">
                        <div class="mb-4">
                            <label class="filter-label">Concepto o intención</label>
                            <textarea id="semanticInput" rows="3" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary" placeholder="Describe lo que buscas en lenguaje natural..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="filter-label">Tipo de contenido</label>
                            <div class="flex flex-wrap">
                                <span class="filter-chip semantic-type" data-type="marketing">Marketing</span>
                                <span class="filter-chip semantic-type" data-type="analisis">Análisis</span>
                                <span class="filter-chip semantic-type" data-type="creativo">Creativo</span>
                                <span class="filter-chip semantic-type" data-type="tecnico">Técnico</span>
                                <span class="filter-chip semantic-type" data-type="educacion">Educación</span>
                            </div>
                        </div>
                        <button id="performSemanticSearch" class="px-4 py-2 bg-accent-purple text-white rounded-lg hover:bg-purple-700 transition">
                            Buscar por significado
                        </button>
                    </div>

                    <!-- Búsqueda por Similitud -->
                    <div id="similaritySearch" class="tab-content hidden">
                        <div class="mb-4">
                            <label class="filter-label">Prompt de referencia</label>
                            <textarea id="similarityInput" rows="4" class="w-full bg-input border border-custom rounded-lg p-2.5 text-primary placeholder:text-tertiary" placeholder="Pega un prompt aquí para encontrar similares..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="filter-label">Nivel de similitud</label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="similarityThreshold" min="0" max="100" value="50" class="flex-1">
                                <span id="similarityValue" class="text-sm text-secondary">50%</span>
                            </div>
                        </div>
                        <button id="performSimilaritySearch" class="px-4 py-2 bg-accent-green text-white rounded-lg hover:bg-green-700 transition">
                            Encontrar similares
                        </button>
                    </div>

                    <!-- Búsquedas Guardadas -->
                    <div id="savedSearches" class="tab-content hidden">
                        <div id="savedSearchesList" class="space-y-2">
                            <!-- Las búsquedas guardadas se mostrarán aquí -->
                        </div>
                        <div id="noSavedSearches" class="text-center text-tertiary py-8 hidden">
                            <svg class="w-12 h-12 mx-auto mb-2 text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <p>No tienes búsquedas guardadas aún</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas de búsqueda -->
            <div id="searchStats" class="search-stats hidden">
                <div class="text-sm text-secondary">
                    <span id="resultCount">0</span> resultados encontrados
                </div>
                <div class="text-sm text-secondary">
                    Ordenado por: <span id="sortBy" class="font-medium">relevancia</span>
                </div>
            </div>
            
            <div id="tagFilterList" class="mb-6 flex flex-wrap gap-2 justify-center">
            </div>
            
            <div id="savedPromptsList" class="space-y-4">
            </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a los elementos del DOM
            const rolInput = document.getElementById('rol');
            const contextoInput = document.getElementById('contexto');
            const tareaInput = document.getElementById('tarea');
            const formatoInput = document.getElementById('formato');
            const restriccionesInput = document.getElementById('restricciones');
            const generateBtn = document.getElementById('generateBtn');
            const saveBtn = document.getElementById('saveBtn');
            const copyBtn = document.getElementById('copyBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const outputPrompt = document.getElementById('outputPrompt');
            const feedback = document.getElementById('feedback');
            const savedPromptsList = document.getElementById('savedPromptsList');
            const searchInput = document.getElementById('searchInput');
            const tagInput = document.getElementById('tagInput');
            const tagsContainer = document.getElementById('tagsContainer');
            const tagSuggestions = document.getElementById('tagSuggestions');
            const extractTagsBtn = document.getElementById('extractTagsBtn');
            const tagFilterList = document.getElementById('tagFilterList');
            const themeButtons = document.querySelectorAll('.theme-btn');
            const templateToggle = document.getElementById('templateToggle');
            const templateMenu = document.getElementById('templateMenu');
            const selectedTemplate = document.getElementById('selectedTemplate');
            
            // Elementos del análisis
            const analysisResults = document.getElementById('analysisResults');
            const closeAnalysis = document.getElementById('closeAnalysis');
            const scoreValue = document.getElementById('scoreValue');
            const scoreLabel = document.getElementById('scoreLabel');
            const progressFill = document.getElementById('progressFill');
            const suggestionsList = document.getElementById('suggestionsList');
            const keywordsList = document.getElementById('keywordsList');

            // Elementos de búsqueda avanzada
            const toggleAdvancedSearch = document.getElementById('toggleAdvancedSearch');
            const toggleText = document.getElementById('toggleText');
            const toggleIcon = document.getElementById('toggleIcon');
            const advancedFilters = document.getElementById('advancedFilters');
            const searchTabs = document.querySelectorAll('.search-tab');
            const searchTabContent = document.getElementById('searchTabContent');
            const searchStats = document.getElementById('searchStats');
            const resultCount = document.getElementById('resultCount');
            const sortBy = document.getElementById('sortBy');

            let savedPrompts = [];
            let filteredPrompts = [];
            let activeTagFilter = null;
            let currentSearchTab = 'basic';
            let savedSearches = [];
            let searchFilters = {
                tags: [],
                dateFrom: null,
                dateTo: null,
                usage: 'all',
                quality: 'all',
                searchTerm: '',
                semanticQuery: '',
                similarityThreshold: 50
            };

            // Sistema de etiquetas mejorado
            let currentTags = [];
            let tagSuggestionsList = [];
            let selectedSuggestionIndex = -1;

            // --- Sistema de Temas Mejorado ---
            const themes = ['light', 'dark', 'ocean', 'forest'];
            
            // Cargar tema guardado o usar el predeterminado
            const savedTheme = localStorage.getItem('selectedTheme') || 'light';
            setTheme(savedTheme);

            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newTheme = button.dataset.theme;
                    setTheme(newTheme);
                    localStorage.setItem('selectedTheme', newTheme);
                });
            });

            function setTheme(themeName) {
                if (!themes.includes(themeName)) return;
                
                // Añadir animación de transición
                document.body.classList.add('theme-changing');
                
                setTimeout(() => {
                    document.body.setAttribute('data-theme', themeName);
                    
                    // Actualizar botones activos
                    themeButtons.forEach(btn => {
                        if (btn.dataset.theme === themeName) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    
                    // Guardar en localStorage
                    localStorage.setItem('selectedTheme', themeName);
                    
                    // Remover animación
                    setTimeout(() => {
                        document.body.classList.remove('theme-changing');
                    }, 300);
                }, 150);
            }

            // --- Sistema de Etiquetas Mejorado ---
            
            // Base de datos de palabras clave para extracción automática
            const keywordDatabase = {
                roles: ['experto', 'especialista', 'analista', 'consultor', 'desarrollador', 'diseñador', 'estratega', 'investigador', 'profesor', 'escritor'],
                actions: ['analizar', 'crear', 'generar', 'diseñar', 'desarrollar', 'escribir', 'explicar', 'resumir', 'evaluar', 'optimizar'],
                topics: ['marketing', 'ventas', 'contenido', 'datos', 'código', 'diseño', 'educación', 'negocios', 'tecnología', 'finanzas'],
                formats: ['lista', 'tabla', 'informe', 'artículo', 'email', 'presentación', 'documento', 'guía'],
                qualities: ['profesional', 'claro', 'conciso', 'detallado', 'sencillo', 'técnico', 'creativo', 'formal']
            };

            function extractTagsFromPrompt() {
                const promptText = outputPrompt.textContent;
                if (!promptText || promptText === 'El prompt generado aparecerá aquí...') {
                    showFeedback('Genera un prompt primero para extraer etiquetas', 'yellow');
                    return;
                }

                const extractedTags = new Set();
                const text = promptText.toLowerCase();

                // Extraer palabras clave de cada categoría
                Object.entries(keywordDatabase).forEach(([category, keywords]) => {
                    keywords.forEach(keyword => {
                        if (text.includes(keyword)) {
                            extractedTags.add(keyword);
                        }
                    });
                });

                // Extraer hashtags existentes
                const hashtagMatches = text.match(/#\w+/g);
                if (hashtagMatches) {
                    hashtagMatches.forEach(tag => extractedTags.add(tag));
                }

                // Extraer términos específicos del prompt
                const specificTerms = extractSpecificTerms(promptText);
                specificTerms.forEach(term => extractedTags.add(term));

                // Convertir a array y limitar a 5 etiquetas
                const tagsArray = Array.from(extractedTags).slice(0, 5);
                
                // Actualizar etiquetas actuales
                currentTags = tagsArray.map(tag => ({
                    text: tag.startsWith('#') ? tag : `#${tag}`,
                    type: 'suggested',
                    editable: true
                }));

                renderTags();
                showFeedback(`Se extrajeron ${currentTags.length} etiquetas del prompt`, 'green');
            }

            function extractSpecificTerms(text) {
                const terms = [];
                
                // Extraer roles mencionados
                const roleMatches = text.match(/Actúa como:\s*([^\n]+)/i);
                if (roleMatches) {
                    const role = roleMatches[1].trim();
                    const roleWords = role.split(' ').filter(word => word.length > 3);
                    terms.push(...roleWords.slice(0, 2));
                }

                // Extraer palabras clave del contexto
                const contextMatches = text.match(/CONTEXTO\s*([^\n]+)/i);
                if (contextMatches) {
                    const context = contextMatches[1].toLowerCase();
                    keywordDatabase.topics.forEach(topic => {
                        if (context.includes(topic)) {
                            terms.push(topic);
                        }
                    });
                }

                // Extraer palabras clave de la tarea
                const taskMatches = text.match(/TAREA\s*([^\n]+)/i);
                if (taskMatches) {
                    const task = taskMatches[1].toLowerCase();
                    keywordDatabase.actions.forEach(action => {
                        if (task.includes(action)) {
                            terms.push(action);
                        }
                    });
                }

                return [...new Set(terms)];
            }

            function renderTags() {
                // Limpiar contenedor excepto el input
                const input = tagsContainer.querySelector('.tag-input');
                tagsContainer.innerHTML = '';
                
                // Renderizar etiquetas actuales
                currentTags.forEach((tag, index) => {
                    const tagElement = createTagElement(tag, index);
                    tagsContainer.appendChild(tagElement);
                });
                
                // Volver a añadir el input
                tagsContainer.appendChild(input);
            }

            function createTagElement(tag, index) {
                const tagChip = document.createElement('div');
                tagChip.className = `tag-chip ${tag.type}`;
                tagChip.dataset.index = index;
                
                if (tag.editing) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = tag.text;
                    input.className = 'tag-edit-input';
                    input.style.cssText = 'background: transparent; border: none; color: white; outline: none; width: 100px;';
                    
                    input.addEventListener('blur', () => finishEditingTag(index));
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            finishEditingTag(index);
                        } else if (e.key === 'Escape') {
                            cancelEditingTag(index);
                        }
                    });
                    
                    tagChip.appendChild(input);
                    setTimeout(() => input.focus(), 0);
                } else {
                    tagChip.innerHTML = `
                        <span>${tag.text}</span>
                        ${tag.type === 'suggested' ? '<span class="tag-type-indicator">IA</span>' : ''}
                        <span class="tag-remove" onclick="removeTag(${index})">×</span>
                    `;
                    
                    tagChip.addEventListener('dblclick', () => startEditingTag(index));
                }
                
                return tagChip;
            }

            function addTag(text, type = 'manual') {
                const cleanText = text.trim().startsWith('#') ? text.trim() : `#${text.trim()}`;
                
                // Verificar si ya existe
                if (currentTags.some(tag => tag.text.toLowerCase() === cleanText.toLowerCase())) {
                    showFeedback('Esta etiqueta ya existe', 'yellow');
                    return;
                }
                
                currentTags.push({
                    text: cleanText,
                    type: type,
                    editable: true
                });
                
                renderTags();
                tagInput.value = '';
                hideTagSuggestions();
            }

            function removeTag(index) {
                currentTags.splice(index, 1);
                renderTags();
            }

            function startEditingTag(index) {
                currentTags[index].editing = true;
                renderTags();
            }

            function finishEditingTag(index) {
                const input = tagsContainer.querySelector(`[data-index="${index}"] input`);
                if (input) {
                    const newText = input.value.trim();
                    if (newText && newText !== currentTags[index].text) {
                        currentTags[index].text = newText.startsWith('#') ? newText : `#${newText}`;
                    }
                }
                currentTags[index].editing = false;
                renderTags();
            }

            function cancelEditingTag(index) {
                currentTags[index].editing = false;
                renderTags();
            }

            function showTagSuggestions(query) {
                if (query.length < 2) {
                    hideTagSuggestions();
                    return;
                }
                
                const allSuggestions = [
                    ...keywordDatabase.roles,
                    ...keywordDatabase.actions,
                    ...keywordDatabase.topics,
                    ...keywordDatabase.formats,
                    ...keywordDatabase.qualities
                ];
                
                tagSuggestionsList = allSuggestions
                    .filter(suggestion => 
                        suggestion.toLowerCase().includes(query.toLowerCase()) &&
                        !currentTags.some(tag => tag.text === `#${suggestion}`)
                    )
                    .slice(0, 5);
                
                if (tagSuggestionsList.length > 0) {
                    renderTagSuggestions();
                } else {
                    hideTagSuggestions();
                }
            }

            function renderTagSuggestions() {
                tagSuggestions.innerHTML = '';
                tagSuggestionsList.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'tag-suggestion-item';
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('selected');
                    }
                    item.textContent = `#${suggestion}`;
                    item.addEventListener('click', () => {
                        addTag(suggestion, 'suggested');
                        tagInput.value = '';
                        hideTagSuggestions();
                    });
                    tagSuggestions.appendChild(item);
                });
                tagSuggestions.classList.remove('hidden');
            }

            function hideTagSuggestions() {
                tagSuggestions.classList.add('hidden');
                selectedSuggestionIndex = -1;
            }

            // Event listeners para el sistema de etiquetas
            extractTagsBtn.addEventListener('click', extractTagsFromPrompt);

            tagInput.addEventListener('input', (e) => {
                showTagSuggestions(e.target.value);
            });

            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = tagInput.value.trim();
                    if (value) {
                        if (selectedSuggestionIndex >= 0) {
                            addTag(tagSuggestionsList[selectedSuggestionIndex], 'suggested');
                        } else {
                            addTag(value, 'manual');
                        }
                        tagInput.value = '';
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, tagSuggestionsList.length - 1);
                    renderTagSuggestions();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, 0);
                    renderTagSuggestions();
                } else if (e.key === 'Escape') {
                    hideTagSuggestions();
                }
            });

            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!tagsContainer.contains(e.target) && !tagSuggestions.contains(e.target)) {
                    hideTagSuggestions();
                }
            });

            // --- Plantillas Predefinidas ---
            const predefinedTemplates = {
                escritura: {
                    name: "Redacción de Contenido",
                    templates: [
                        {
                            name: "Artículo de Blog",
                            rol: "Experto en contenido digital y copywriting",
                            contexto: "Estás escribiendo para un blog especializado en [tema]. El público objetivo son [descripción del público]. El objetivo es informar y entretener mientras se establece autoridad en el tema.",
                            tarea: "Escribe un artículo completo sobre [tema específico] que incluya introducción, puntos clave y conclusión.",
                            formato: "Estructura de blog con título atractivo, subtítulos, párrafos cortos y llamada a la acción final.",
                            restricciones: "Tono conversacional pero profesional. Longitud: 800-1200 palabras. Incluir al menos 3 ejemplos prácticos."
                        },
                        {
                            name: "Email Profesional",
                            rol: "Comunicador corporativo experto",
                            contexto: "Necesitas redactar un email para [propósito]. El destinatario es [descripción del destinatario]. La relación es [formal/informal].",
                            tarea: "Redacta un email claro y efectivo que logre [objetivo principal].",
                            formato: "Asunto claro y conciso. Saludo apropiado. Cuerpo del mensaje estructurado en 2-3 párrafos. Cierre profesional.",
                            restricciones: "Máximo 200 palabras. Sin jerga excesiva. Incluir llamada a la acción específica."
                        },
                        {
                            name: "Redes Sociales",
                            rol: "Community Manager y estratega de social media",
                            contexto: "Estás creando contenido para [plataforma social]. La marca tiene [personalidad de marca]. El objetivo es [objetivo de campaña].",
                            tarea: "Crea 5 publicaciones atractivas sobre [tema] para la plataforma seleccionada.",
                            formato: "Texto principal + hashtags relevantes. Considerar límites de caracteres de la plataforma.",
                            restricciones: "Tono [formal/informal/divertido]. Incluir emojis apropiados. Máximo 280 caracteres por publicación."
                        }
                    ]
                },
                analisis: {
                    name: "Análisis y Datos",
                    templates: [
                        {
                            name: "Análisis de Datos",
                            rol: "Analista de datos senior",
                            contexto: "Se te proporcionará un conjunto de datos sobre [tipo de datos]. El objetivo es extraer insights valiosos para [audiencia].",
                            tarea: "Analiza los datos y proporciona conclusiones accionables y recomendaciones específicas.",
                            formato: "Resumen ejecutivo + hallazgos clave + visualizaciones sugeridas + recomendaciones priorizadas.",
                            restricciones: "Enfócate en insights prácticos. Explicar términos técnicos si es necesario. Máximo 2 páginas."
                        },
                        {
                            name: "Análisis DAFO",
                            rol: "Consultor de estrategia empresarial",
                            contexto: "Realizando un análisis estratégico para [empresa/proyecto]. El sector es [industria]. El mercado actual está [descripción del mercado].",
                            tarea: "Desarrolla un análisis DAFO completo identificando fortalezas, debilidades, oportunidades y amenazas.",
                            formato: "Matriz DAFO con 4-5 elementos por categoría. Análisis estratégico basado en resultados.",
                            restricciones: "Ser específico y realista. Priorizar factores más impactantes. Incluir recomendaciones estratégicas."
                        },
                        {
                            name: "Análisis de Competencia",
                            rol: "Investigador de mercado",
                            contexto: "Analizando el panorama competitivo en [sector]. Los principales competidores son [lista de competidores].",
                            tarea: "Realiza un análisis comparativo detallado de competidores clave.",
                            formato: "Tabla comparativa + análisis de fortalezas y debilidades + oportunidades de diferenciación.",
                            restricciones: "Basarse en datos verificables. Ser objetivo. Identificar gaps en el mercado."
                        }
                    ]
                },
                creativo: {
                    name: "Creatividad e Ideas",
                    templates: [
                        {
                            name: "Brainstorming",
                            rol: "Facilitador de creatividad e innovación",
                            contexto: "Un equipo necesita generar ideas frescas para [proyecto/iniciativa]. El ambiente debe ser de apertura y sin juicios.",
                            tarea: "Conduce una sesión de brainstorming generando ideas diversas y creativas sobre [tema].",
                            formato: "Lista de ideas sin censura. Categorizar por tipo o viabilidad si es posible.",
                            restricciones: "Cantidad sobre calidad inicialmente. No juzgar ideas. Mínimo 20 ideas diversas."
                        },
                        {
                            name: "Historia Corta",
                            rol: "Escritor creativo y narrador",
                            contexto: "Creando una historia original con [género literario]. Ambientada en [época/lugar]. Dirigida a [público objetivo].",
                            tarea: "Escribe una historia corta completa con personajes, trama y resolución satisfactoria.",
                            formato: "Estructura narrativa clásica: introducción, nudo, desenlace. Diálogos naturales.",
                            restricciones: "Longitud: 800-1500 palabras. Tono consistente. Final impactante o reflexivo."
                        },
                        {
                            name: "Naming y Branding",
                            rol: "Estratega de marca y creativo de nombres",
                            contexto: "Desarrollando identidad de marca para [tipo de empresa/producto]. Los valores de marca son [valores].",
                            tarea: "Genera opciones de nombres creativos y memorables junto con conceptos de branding.",
                            formato: "Lista de nombres + justificación de cada uno + conceptos visuales sugeridos.",
                            restricciones: "Nombres fáciles de pronunciar y recordar. Verificar disponibilidad básica. Mínimo 10 opciones."
                        }
                    ]
                },
                tecnico: {
                    name: "Técnico y Desarrollo",
                    templates: [
                        {
                            name: "Generación de Código",
                            rol: "Programador senior experto en [lenguaje]",
                            contexto: "Desarrollando una funcionalidad para [tipo de aplicación]. El sistema usa [tecnologías]. Los requisitos son [requisitos específicos].",
                            tarea: "Escribe código limpio y eficiente que implemente [funcionalidad específica].",
                            formato: "Código bien comentado + explicación de la lógica + ejemplos de uso + manejo de errores.",
                            restricciones: "Seguir mejores prácticas de [lenguaje]. Código modular y reutilizable. Incluir pruebas básicas."
                        },
                        {
                            name: "Documentación Técnica",
                            rol: "Technical writer especializado",
                            contexto: "Creando documentación para [producto/sistema]. La audiencia es [descripción de usuarios]. El nivel técnico es [básico/intermedio/avanzado].",
                            tarea: "Escribe documentación clara y completa para [funcionalidad/proceso].",
                            formato: "Introducción + prerrequisitos + pasos detallados + ejemplos + solución de problemas comunes.",
                            restricciones: "Lenguaje claro y preciso. Incluir capturas de pantalla o diagramas si es necesario. Estructura lógica."
                        },
                        {
                            name: "Debugging y Solución",
                            rol: "Ingeniero de software especializado en debugging",
                            contexto: "Se ha encontrado un error en [sistema/aplicación]. Los síntomas son [descripción del problema]. El entorno es [tecnologías usadas].",
                            tarea: "Analiza el problema y proporciona soluciones efectivas para corregir el error.",
                            formato: "Descripción del problema + posibles causas + solución paso a paso + pruebas de verificación.",
                            restricciones: "Ser metódico en el análisis. Explicar el porqué de cada paso. Incluir medidas preventivas."
                        }
                    ]
                },
                negocio: {
                    name: "Negocio y Estrategia",
                    templates: [
                        {
                            name: "Plan de Negocio",
                            rol: "Consultor de negocios y estratega",
                            contexto: "Desarrollando un plan de negocio para [tipo de empresa]. El mercado objetivo es [descripción]. La inversión inicial es [monto].",
                            tarea: "Crea un plan de negocio completo y realista.",
                            formato: "Resumen ejecutivo + análisis de mercado + estrategia de marketing + proyecciones financieras + riesgos.",
                            restricciones: "Ser realista y basado en datos. Incluir métricas clave. Timeline específico."
                        },
                        {
                            name: "Propuesta Comercial",
                            rol: "Especialista en ventas y propuestas",
                            contexto: "Preparando una propuesta para [cliente potencial]. El producto/servicio es [descripción]. El presupuesto es [rango].",
                            tarea: "Desarrolla una propuesta comercial persuasiva y profesional.",
                            formato: "Carta de presentación + entendimiento del problema + solución propuesta + beneficios + inversión + próximos pasos.",
                            restricciones: "Enfocarse en valor del cliente. Ser claro y conciso. Incluir elementos diferenciadores."
                        },
                        {
                            name: "Estrategia de Marketing",
                            rol: "Director de marketing digital",
                            contexto: "Desarrollando estrategia para [producto/marca]. El presupuesto es [monto]. El objetivo principal es [objetivo específico].",
                            tarea: "Crea una estrategia de marketing integral y accionable.",
                            formato: "Análisis de situación + objetivos SMART + estrategias tácticas + calendario + KPIs + presupuesto detallado.",
                            restricciones: "Estrategia realista y medible. Considerar diferentes canales. Incluir plan de contingencia."
                        }
                    ]
                },
                educacion: {
                    name: "Educación y Aprendizaje",
                    templates: [
                        {
                            name: "Plan de Lección",
                            rol: "Diseñador instruccional educativo",
                            contexto: "Creando una lección sobre [tema] para [nivel educativo]. La duración es [tiempo]. El grupo tiene [características especiales].",
                            tarea: "Diseña un plan de lección completo y efectivo.",
                            formato: "Objetivos de aprendizaje + materiales + actividades + evaluación + adaptaciones para diferentes niveles.",
                            restricciones: "Alineado con estándares educativos. Incluir actividades interactivas. Considerar diferentes estilos de aprendizaje."
                        },
                        {
                            name: "Explicación Concepto",
                            rol: "Experto en comunicación educativa",
                            contexto: "Explicando [concepto complejo] a [audiencia específica]. El nivel de conocimiento previo es [descripción].",
                            tarea: "Explica el concepto de manera clara, comprensible y memorable.",
                            formato: "Introducción simple + analogías + explicación detallada + ejemplos prácticos + resumen clave.",
                            restricciones: "Usar lenguaje adecuado para la audiencia. Incluir metáforas o analogías. Evitar tecnicismos innecesarios."
                        },
                        {
                            name: "Material de Estudio",
                            rol: "Experto en técnicas de estudio",
                            contexto: "Creando material de estudio para [asignatura/tema]. El método de evaluación será [tipo de examen].",
                            tarea: "Desarrolla material de estudio efectivo y completo.",
                            formato: "Resúmenes + mapas conceptuales + preguntas de práctica + técnicas de memorización + guía de estudio.",
                            restricciones: "Estructura lógica y progresiva. Incluir diferentes formatos. Enfocarse en puntos clave."
                        }
                    ]
                }
            };

            // --- Funciones de Plantillas ---
            function renderTemplateMenu() {
                templateMenu.innerHTML = '';
                
                for (const [categoryKey, category] of Object.entries(predefinedTemplates)) {
                    // Categoría
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'template-category';
                    categoryDiv.textContent = category.name;
                    templateMenu.appendChild(categoryDiv);
                    
                    // Plantillas de la categoría
                    category.templates.forEach(template => {
                        const templateItem = document.createElement('div');
                        templateItem.className = 'template-item';
                        templateItem.innerHTML = `
                            <div class="font-medium text-primary">${template.name}</div>
                            <div class="text-xs text-tertiary mt-1">${template.rol}</div>
                        `;
                        templateItem.addEventListener('click', () => selectTemplate(template));
                        templateMenu.appendChild(templateItem);
                    });
                }
            }

            function selectTemplate(template) {
                rolInput.value = template.rol;
                contextoInput.value = template.contexto;
                tareaInput.value = template.tarea;
                formatoInput.value = template.formato;
                restriccionesInput.value = template.restricciones;
                
                selectedTemplate.textContent = template.name;
                selectedTemplate.classList.remove('text-tertiary');
                selectedTemplate.classList.add('text-primary');
                
                templateMenu.classList.add('hidden');
                generatePrompt();
                
                showFeedback(`Plantilla "${template.name}" aplicada`, 'blue');
            }

            // Toggle del menú de plantillas
            templateToggle.addEventListener('click', () => {
                templateMenu.classList.toggle('hidden');
            });

            // Cerrar menú al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!templateToggle.contains(e.target) && !templateMenu.contains(e.target)) {
                    templateMenu.classList.add('hidden');
                }
            });

            // --- Sistema de Búsqueda Avanzada ---
            
            // Toggle de filtros avanzados
            toggleAdvancedSearch.addEventListener('click', () => {
                const isHidden = advancedFilters.classList.contains('hidden');
                advancedFilters.classList.toggle('hidden');
                toggleText.textContent = isHidden ? 'Ocultar filtros' : 'Mostrar filtros';
                toggleIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
            });

            // Sistema de pestañas
            searchTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchSearchTab(tabName);
                });
            });

            function switchSearchTab(tabName) {
                currentSearchTab = tabName;
                
                // Actualizar pestañas activas
                searchTabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Ocultar todo el contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Mostrar contenido seleccionado
                document.getElementById(`${tabName}Search`).classList.remove('hidden');
                
                // Cargar contenido específico si es necesario
                if (tabName === 'saved') {
                    renderSavedSearches();
                }
            }

            // Búsqueda semántica
            const semanticKeywords = {
                marketing: ['marketing', 'publicidad', 'ventas', 'cliente', 'campaña', 'contenido', 'redes sociales', 'estrategia'],
                analisis: ['analizar', 'datos', 'estadísticas', 'informe', 'métricas', 'evaluar', 'resultado'],
                creativo: ['crear', 'diseñar', 'innovar', 'idea', 'brainstorming', 'concepto', 'original'],
                tecnico: ['código', 'programar', 'desarrollar', 'técnico', 'sistema', 'función', 'algoritmo'],
                educacion: ['enseñar', 'aprender', 'explicar', 'concepto', 'lección', 'educativo', 'formación']
            };

            function performSemanticSearch() {
                const query = document.getElementById('semanticInput').value.toLowerCase();
                const selectedTypes = Array.from(document.querySelectorAll('.semantic-type.active')).map(el => el.dataset.type);
                
                if (!query && selectedTypes.length === 0) {
                    showFeedback('Ingresa un concepto o selecciona un tipo de contenido', 'yellow');
                    return;
                }
                
                let results = savedPrompts.filter(prompt => {
                    let score = 0;
                    const text = prompt.text.toLowerCase();
                    
                    // Calcular puntuación semántica
                    for (const [type, keywords] of Object.entries(semanticKeywords)) {
                        if (selectedTypes.length === 0 || selectedTypes.includes(type)) {
                            keywords.forEach(keyword => {
                                if (text.includes(keyword)) score += 10;
                            });
                        }
                    }
                    
                    // Búsqueda por coincidencias parciales
                    const queryWords = query.split(' ');
                    queryWords.forEach(word => {
                        if (word.length > 2 && text.includes(word)) score += 5;
                    });
                    
                    prompt.semanticScore = score;
                    return score > 0;
                });
                
                // Ordenar por puntuación semántica
                results.sort((a, b) => b.semanticScore - a.semanticScore);
                
                filteredPrompts = results;
                renderSavedPrompts(results);
                updateSearchStats(results.length, 'relevancia semántica');
                
                if (results.length === 0) {
                    showFeedback('No se encontraron resultados semánticamente relacionados', 'yellow');
                } else {
                    showFeedback(`Se encontraron ${results.length} resultados por similitud semántica`, 'green');
                }
            }

            // Búsqueda por similitud
            function calculateSimilarity(text1, text2) {
                const words1 = text1.toLowerCase().split(' ');
                const words2 = text2.toLowerCase().split(' ');
                const intersection = words1.filter(word => words2.includes(word));
                const union = [...new Set([...words1, ...words2])];
                return intersection.length / union.length;
            }

            function performSimilaritySearch() {
                const referenceText = document.getElementById('similarityInput').value;
                const threshold = parseInt(document.getElementById('similarityThreshold').value) / 100;
                
                if (!referenceText) {
                    showFeedback('Ingresa un prompt de referencia', 'yellow');
                    return;
                }
                
                let results = savedPrompts.filter(prompt => {
                    const similarity = calculateSimilarity(referenceText, prompt.text);
                    prompt.similarity = similarity;
                    return similarity >= threshold;
                });
                
                // Ordenar por similitud
                results.sort((a, b) => b.similarity - a.similarity);
                
                filteredPrompts = results;
                renderSavedPrompts(results);
                updateSearchStats(results.length, 'similitud');
                
                if (results.length === 0) {
                    showFeedback('No se encontraron prompts similares', 'yellow');
                } else {
                    showFeedback(`Se encontraron ${results.length} prompts similares`, 'green');
                }
            }

            // Actualizar valor del slider de similitud
            document.getElementById('similarityThreshold').addEventListener('input', (e) => {
                document.getElementById('similarityValue').textContent = `${e.target.value}%`;
            });

            // Guardar búsqueda
            document.getElementById('saveSearchBtn').addEventListener('click', () => {
                const searchName = prompt('Nombre para esta búsqueda:');
                if (!searchName) return;
                
                const searchToSave = {
                    id: Date.now(),
                    name: searchName,
                    filters: { ...searchFilters },
                    timestamp: new Date().toISOString(),
                    tab: currentSearchTab
                };
                
                savedSearches.push(searchToSave);
                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                showFeedback('Búsqueda guardada exitosamente', 'green');
            });

            // Renderizar búsquedas guardadas
            function renderSavedSearches() {
                const container = document.getElementById('savedSearchesList');
                const noResults = document.getElementById('noSavedSearches');
                
                if (savedSearches.length === 0) {
                    container.innerHTML = '';
                    noResults.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                container.innerHTML = '';
                
                savedSearches.forEach(search => {
                    const item = document.createElement('div');
                    item.className = 'saved-search-item';
                    item.innerHTML = `
                        <div>
                            <div class="saved-search-name">${search.name}</div>
                            <div class="saved-search-query">Guardado: ${new Date(search.timestamp).toLocaleDateString()}</div>
                        </div>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteSavedSearch(${search.id})">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    `;
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadSavedSearch(search);
                        }
                    });
                    container.appendChild(item);
                });
            }

            // Cargar búsqueda guardada
            function loadSavedSearch(search) {
                searchFilters = { ...search.filters };
                currentSearchTab = search.tab;
                
                // Aplicar filtros
                applyAllFilters();
                
                // Cambiar a la pestaña correspondiente
                switchSearchTab(search.tab);
                
                showFeedback(`Búsqueda "${search.name}" cargada`, 'green');
            }

            // Eliminar búsqueda guardada
            window.deleteSavedSearch = function(id) {
                savedSearches = savedSearches.filter(s => s.id !== id);
                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                renderSavedSearches();
                showFeedback('Búsqueda eliminada', 'green');
            };

            // Event listeners para búsqueda semántica y similitud
            document.getElementById('performSemanticSearch').addEventListener('click', performSemanticSearch);
            document.getElementById('performSimilaritySearch').addEventListener('click', performSimilaritySearch);

            // Event listeners para filtros de tipo semántico
            document.querySelectorAll('.semantic-type').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                });
            });

            // Actualizar estadísticas de búsqueda
            function updateSearchStats(count, sortMethod) {
                searchStats.classList.remove('hidden');
                resultCount.textContent = count;
                sortBy.textContent = sortMethod;
            }

            // --- Sistema de Análisis IA-Powered ---
            const actionKeywords = [
                'analiza', 'compara', 'crea', 'resume', 'explica', 'genera', 'evalúa', 
                'diseña', 'identifica', 'propón', 'optimiza', 'traduce', 'clasifica',
                'organiza', 'prioriza', 'sintetiza', 'interpreta', 'modifica', 'mejora'
            ];

            function performPromptAnalysis() {
                const promptData = {
                    rol: rolInput.value.trim(),
                    contexto: contextoInput.value.trim(),
                    tarea: tareaInput.value.trim(),
                    formato: formatoInput.value.trim(),
                    restricciones: restriccionesInput.value.trim()
                };

                const analysis = analyzePromptQuality(promptData);
                displayAnalysisResults(analysis);
            }

            function analyzePromptQuality(data) {
                let score = 0;
                const suggestions = [];
                const foundKeywords = new Set();

                // Análisis del Rol (20 puntos)
                if (data.rol) {
                    score += 15;
                    if (data.rol.length > 10) score += 5;
                } else {
                    suggestions.push({
                        type: 'error',
                        icon: '❌',
                        text: 'Define un rol claro para la IA (ej: "Experto en marketing digital").'
                    });
                }

                // Análisis del Contexto (25 puntos)
                if (data.contexto) {
                    score += 15;
                    if (data.contexto.length > 50) score += 10;
                } else {
                    suggestions.push({
                        type: 'error',
                        icon: '❌',
                        text: 'Añade contexto para ayudar a la IA a entender la situación.'
                    });
                }

                // Análisis de la Tarea (30 puntos)
                if (data.tarea) {
                    score += 20;
                    if (data.tarea.length > 20) score += 5;
                    
                    // Buscar palabras de acción
                    const tareaLower = data.tarea.toLowerCase();
                    let hasActionKeyword = false;
                    actionKeywords.forEach(keyword => {
                        if (tareaLower.includes(keyword)) {
                            hasActionKeyword = true;
                            foundKeywords.add(keyword);
                        }
                    });
                    
                    if (hasActionKeyword) score += 5;
                    else {
                        suggestions.push({
                            type: 'warning',
                            icon: '⚠️',
                            text: 'Usa verbos de acción claros como "analiza", "crea" o "explica".'
                        });
                    }
                } else {
                    suggestions.push({
                        type: 'error',
                        icon: '❌',
                        text: 'Especifica claramente la tarea que debe realizar la IA.'
                    });
                }

                // Análisis del Formato (15 puntos)
                if (data.formato) {
                    score += 10;
                    if (data.formato.length > 15) score += 5;
                } else {
                    suggestions.push({
                        type: 'warning',
                        icon: '⚠️',
                        text: 'Define el formato de salida para obtener resultados consistentes.'
                    });
                }

                // Análisis de Restricciones (10 puntos)
                if (data.restricciones) {
                    score += 10;
                } else {
                    suggestions.push({
                        type: 'tip',
                        icon: '💡',
                        text: 'Considera añadir restricciones como tono, longitud o formato.'
                    });
                }

                // Longitud total del prompt
                const totalLength = Object.values(data).join('').length;
                if (totalLength < 100) {
                    suggestions.push({
                        type: 'warning',
                        icon: '⚠️',
                        text: 'El prompt parece muy corto. Añade más detalles para mejores resultados.'
                    });
                } else if (totalLength > 1000) {
                    suggestions.push({
                        type: 'tip',
                        icon: '💡',
                        text: 'El prompt es muy largo. Considera ser más conciso para evitar confusión.'
                    });
                }

                // Generar palabras clave recomendadas
                const recommendedKeywords = actionKeywords.filter(keyword => !foundKeywords.has(keyword)).slice(0, 8);

                return {
                    score: Math.min(100, Math.max(0, score)),
                    suggestions,
                    recommendedKeywords
                };
            }

            function displayAnalysisResults(analysis) {
                // Actualizar puntuación
                scoreValue.textContent = analysis.score;
                
                // Determinar etiqueta y color
                let label, colorClass;
                if (analysis.score >= 80) {
                    label = 'Excelente';
                    colorClass = 'score-excellent';
                } else if (analysis.score >= 60) {
                    label = 'Bueno';
                    colorClass = 'score-good';
                } else {
                    label = 'Necesita Mejoras';
                    colorClass = 'score-needs-improvement';
                }
                
                scoreLabel.textContent = label;
                scoreValue.className = `score-display ${colorClass}`;
                
                // Animar barra de progreso
                setTimeout(() => {
                    progressFill.style.width = `${analysis.score}%`;
                }, 100);
                
                // Mostrar sugerencias
                suggestionsList.innerHTML = '';
                if (analysis.suggestions.length === 0) {
                    suggestionsList.innerHTML = '<div class="suggestion-item"><span class="suggestion-icon">✅</span><span class="text-secondary">¡Tu prompt está muy bien estructurado!</span></div>';
                } else {
                    analysis.suggestions.forEach(suggestion => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `
                            <span class="suggestion-icon">${suggestion.icon}</span>
                            <span class="text-secondary">${suggestion.text}</span>
                        `;
                        suggestionsList.appendChild(item);
                    });
                }
                
                // Mostrar palabras clave
                keywordsList.innerHTML = '';
                analysis.recommendedKeywords.forEach(keyword => {
                    const chip = document.createElement('span');
                    chip.className = 'keyword-chip';
                    chip.textContent = keyword;
                    chip.addEventListener('click', () => {
                        tareaInput.value += ` ${keyword}`;
                        generatePrompt();
                    });
                    keywordsList.appendChild(chip);
                });
                
                // Mostrar panel de análisis
                analysisResults.classList.remove('hidden');
                analysisResults.classList.add('analysis-visible');
            }

            // Event listener para el botón de análisis
            analyzeBtn.addEventListener('click', performPromptAnalysis);
            
            // Event listener para cerrar análisis
            closeAnalysis.addEventListener('click', () => {
                analysisResults.classList.add('hidden');
                progressFill.style.width = '0%';
            });

            const templatesByKeyword = {
                marketing: {
                    rol: 'Experto en marketing digital y estratega de contenido',
                    contexto: 'Estás creando una campaña para un nuevo producto de software B2B que aumenta la productividad. El público objetivo son gerentes de proyecto y dueños de pequeñas empresas.',
                    tarea: 'Genera 5 ideas para posts de blog que destaquen los beneficios clave del producto, incluyendo un título atractivo y una breve descripción para cada uno.',
                    formato: 'Una lista numerada. Cada elemento debe tener el formato: "Título: [Título del post]\nDescripción: [Breve párrafo]"',
                    restricciones: 'El tono debe ser profesional pero accesible. Enfócate en la resolución de problemas, no en características técnicas. Máximo 100 palabras por descripción.'
                },
                resumidor: {
                    rol: 'Asistente de investigación experto en síntesis de información',
                    contexto: 'Se te proporcionará un artículo o un texto largo. El objetivo es extraer la información más importante para alguien que no tiene tiempo de leerlo completo.',
                    tarea: 'Resume el texto proporcionado en puntos clave.',
                    formato: 'Una lista con viñetas (bullet points) con los puntos más importantes.',
                    restricciones: 'El resumen no debe exceder las 150 palabras. Mantén un tono neutral y objetivo. No incluyas opiniones personales.'
                },
                programador: {
                    rol: 'Programador Senior experto en Python y buenas prácticas',
                    contexto: 'Un desarrollador junior necesita ayuda para implementar una funcionalidad específica. Busca un código limpio, eficiente y bien comentado.',
                    tarea: 'Escribe una función en Python que ordene una lista de diccionarios por una clave específica.',
                    formato: 'Un bloque de código Python. Incluye comentarios explicando cada parte del código y un ejemplo de uso.',
                    restricciones: 'Sigue las convenciones de estilo PEP 8. La solución debe ser robusta y manejar posibles errores (ej: clave no encontrada).'
                },
                creativo: {
                    rol: 'Facilitador de brainstorming y experto en creatividad',
                    contexto: 'Un equipo está atascado y necesita nuevas ideas para un proyecto. El ambiente debe ser de apertura y sin juicios para fomentar la creatividad.',
                    tarea: 'Genera una lluvia de ideas sobre el tema: "nuevos usos para los drones en la agricultura".',
                    formato: 'Una lista desordenada de ideas, sin importar lo descabelladas que parezcan.',
                    restricciones: 'No autocensures. Cantidad sobre calidad en esta fase. El objetivo es generar al menos 15 ideas diversas.'
                }
            };

            // --- Funciones Principales ---
            const generatePrompt = () => {
                const rol = rolInput.value.trim() || '[ROL NO ESPECIFICADO]';
                const contexto = contextoInput.value.trim() || '[CONTEXTO NO ESPECIFICADO]';
                const tarea = tareaInput.value.trim() || '[TAREA NO ESPECIFICADA]';
                const formato = formatoInput.value.trim() || '[FORMATO NO ESPECIFICADO]';
                const restricciones = restriccionesInput.value.trim() || '[SIN RESTRICCIONES]';

                const restrictionsHtml = restricciones.split('\n').map(line => 
                    `<div><span class="prompt-list-item">-</span> <span class="prompt-content">${line.trim()}</span></div>`
                ).join('');

                const promptHtml = `
                    <div><span class="prompt-header">### ROL</span></div>
                    <div class="prompt-content">Actúa como: ${rol}</div>
                    <br>
                    <div><span class="prompt-header">### CONTEXTO</span></div>
                    <div class="prompt-content">${contexto}</div>
                    <br>
                    <div><span class="prompt-header">### TAREA</span></div>
                    <div class="prompt-content">Realiza la siguiente tarea: ${tarea}</div>
                    <br>
                    <div><span class="prompt-header">### FORMATO DE SALIDA</span></div>
                    <div class="prompt-content">Presenta la respuesta en el siguiente formato: ${formato}</div>
                    <br>
                    <div><span class="prompt-header">### RESTRICCIONES</span></div>
                    <div>Asegúrate de seguir estas reglas:</div>
                    ${restrictionsHtml}
                `.trim();
                
                outputPrompt.innerHTML = promptHtml;
                
                // Habilitar botón de extraer etiquetas
                extractTagsBtn.disabled = false;
            };
            
            const showFeedback = (message, color = 'green') => {
                feedback.textContent = message;
                feedback.className = `text-center text-sm mt-2 h-5 opacity-100 transition-opacity duration-300 text-${color}-400`;
                setTimeout(() => { feedback.style.opacity = '0'; }, 2500);
            };
            
            const copyToClipboard = (textToCopy) => {
                if (!textToCopy || textToCopy === 'El prompt generado aparecerá aquí...') return;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showFeedback('¡Prompt copiado al portapapeles!');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    showFeedback('Error al copiar', 'red');
                });
            };

            const saveCurrentPrompt = () => {
                const textToSave = outputPrompt.textContent;
                if (!textToSave || textToSave === 'El prompt generado aparecerá aquí...') return;
                if (savedPrompts.some(p => p.text === textToSave)) {
                    showFeedback('Este prompt ya está guardado', 'yellow');
                    return;
                }

                const tags = currentTags.map(tag => tag.text);

                const newPrompt = { 
                    id: Date.now(), 
                    text: textToSave, 
                    tags: tags,
                    timestamp: new Date().toISOString(),
                    usageCount: 0,
                    lastUsed: null
                };
                savedPrompts.unshift(newPrompt);
                savePromptsToStorage();
                
                currentTags = [];
                renderTags();
                applyAllFilters();
                renderTagFilters();
                showFeedback('¡Prompt guardado en el historial!');
            };

            const deletePrompt = (id) => {
                savedPrompts = savedPrompts.filter(p => p.id !== id);
                savePromptsToStorage();
                applyAllFilters();
                renderTagFilters();
            };

            // Función para determinar la calidad del prompt
            function getPromptQuality(prompt) {
                const textLength = prompt.text.length;
                let score = 50;
                
                if (textLength > 200) score += 20;
                if (prompt.text.includes('ROL')) score += 15;
                if (prompt.text.includes('CONTEXTO')) score += 15;
                
                if (score >= 80) return 'high';
                if (score >= 60) return 'medium';
                return 'low';
            }

            // Función para formatear fecha relativa
            function getRelativeTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Hoy';
                if (diffDays === 1) return 'Ayer';
                if (diffDays < 7) return `Hace ${diffDays} días`;
                if (diffDays < 30) return `Hace ${Math.floor(diffDays / 7)} semanas`;
                if (diffDays < 365) return `Hace ${Math.floor(diffDays / 30)} meses`;
                return `Hace ${Math.floor(diffDays / 365)} años`;
            }

            // Función para formatear el texto del prompt con el nuevo diseño
            function formatPromptText(text) {
                // Extraer secciones del prompt
                const sections = {
                    rol: text.match(/### ROL\s*\n(.*?)(?=\n###|\n\n|$)/s),
                    contexto: text.match(/### CONTEXTO\s*\n(.*?)(?=\n###|\n\n|$)/s),
                    tarea: text.match(/### TAREA\s*\n(.*?)(?=\n###|\n\n|$)/s),
                    formato: text.match(/### FORMATO DE SALIDA\s*\n(.*?)(?=\n###|\n\n|$)/s),
                    restricciones: text.match(/### RESTRICCIONES\s*\n([\s\S]*?)$/s)
                };

                let formattedHtml = '<div class="prompt-text">';

                // Sección ROL
                if (sections.rol) {
                    const rolContent = sections.rol[1].replace(/^Actúa como:\s*/i, '').trim();
                    formattedHtml += `
                        <div class="prompt-section">
                            <div class="prompt-section-header">
                                <div class="prompt-section-icon icon-rol">👤</div>
                                <h4 class="prompt-section-title">Rol</h4>
                            </div>
                            <div class="prompt-section-content">
                                <strong>${rolContent}</strong>
                            </div>
                        </div>
                    `;
                }

                // Sección CONTEXTO
                if (sections.contexto) {
                    const contextoContent = sections.contexto[1].trim();
                    formattedHtml += `
                        <div class="prompt-section">
                            <div class="prompt-section-header">
                                <div class="prompt-section-icon icon-contexto">🌍</div>
                                <h4 class="prompt-section-title">Contexto</h4>
                            </div>
                            <div class="prompt-section-content">
                                ${contextoContent}
                            </div>
                        </div>
                    `;
                }

                // Sección TAREA
                if (sections.tarea) {
                    const tareaContent = sections.tarea[1].replace(/^Realiza la siguiente tarea:\s*/i, '').trim();
                    formattedHtml += `
                        <div class="prompt-section">
                            <div class="prompt-section-header">
                                <div class="prompt-section-icon icon-tarea">🎯</div>
                                <h4 class="prompt-section-title">Tarea</h4>
                            </div>
                            <div class="prompt-section-content">
                                <strong>${tareaContent}</strong>
                            </div>
                        </div>
                    `;
                }

                // Sección FORMATO
                if (sections.formato) {
                    const formatoContent = sections.formato[1].replace(/^Presenta la respuesta en el siguiente formato:\s*/i, '').trim();
                    formattedHtml += `
                        <div class="prompt-section">
                            <div class="prompt-section-header">
                                <div class="prompt-section-icon icon-formato">📋</div>
                                <h4 class="prompt-section-title">Formato</h4>
                            </div>
                            <div class="prompt-section-content">
                                ${formatoContent}
                            </div>
                        </div>
                    `;
                }

                // Sección RESTRICCIONES
                if (sections.restricciones) {
                    const restriccionesContent = sections.restricciones[1].replace(/^Asegúrate de seguir estas reglas:\s*/i, '').trim();
                    const restrictions = restriccionesContent.split('\n').filter(line => line.trim());
                    
                    formattedHtml += `
                        <div class="prompt-section">
                            <div class="prompt-section-header">
                                <div class="prompt-section-icon icon-restricciones">⚡</div>
                                <h4 class="prompt-section-title">Restricciones</h4>
                            </div>
                            <div class="prompt-section-content">
                                ${restrictions.map(restriction => `
                                    <div class="restriction-item">
                                        <span class="restriction-bullet">•</span>
                                        <span class="restriction-text">${restriction.replace(/^-\s*/, '').trim()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                formattedHtml += '</div>';
                return formattedHtml;
            }
            
            const renderSavedPrompts = (promptsToRender = savedPrompts) => {
                savedPromptsList.innerHTML = '';
                
                if (promptsToRender.length === 0) {
                    if (searchInput.value.trim() !== '' || activeTagFilter) {
                        savedPromptsList.innerHTML = `
                            <div class="empty-state">
                                <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="empty-state-title">No se encontraron prompts</div>
                                <div class="empty-state-description">
                                    No hay prompts que coincidan con los filtros aplicados. Intenta ajustar tu búsqueda o filtros.
                                </div>
                            </div>
                        `;
                    } else {
                        savedPromptsList.innerHTML = `
                            <div class="empty-state">
                                <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                                <div class="empty-state-title">Aún no tienes prompts guardados</div>
                                <div class="empty-state-description">
                                    Comienza creando tu primer prompt y guárdalo para tener acceso rápido a él más tarde.
                                </div>
                            </div>
                        `;
                    }
                    return;
                }
                
                promptsToRender.forEach((prompt, index) => {
                    const quality = getPromptQuality(prompt);
                    const relativeTime = getRelativeTime(prompt.timestamp);
                    
                    // Resaltar términos de búsqueda
                    let highlightedText = prompt.text;
                    if (searchFilters.searchTerm) {
                        const regex = new RegExp(`(${searchFilters.searchTerm})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<span class="search-result-highlight">$1</span>');
                    }
                    
                    const similarityBadge = prompt.similarity ? 
                        `<div class="prompt-badge badge-similarity">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            ${Math.round(prompt.similarity * 100)}% similar
                        </div>` : '';
                    
                    const semanticScore = prompt.semanticScore ? 
                        `<div class="prompt-badge badge-semantic">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            Score: ${prompt.semanticScore}
                        </div>` : '';

                    const tagsHtml = prompt.tags && prompt.tags.length > 0 
                        ? `<div class="prompt-tags-container">
                            ${prompt.tags.map(tag => `<span class="prompt-tag">${tag}</span>`).join('')}
                           </div>`
                        : '<div class="prompt-tags-container"><span class="text-tertiary text-xs">Sin etiquetas</span></div>';

                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    
                    card.innerHTML = `
                        <div class="quality-indicator quality-${quality}"></div>
                        
                        <div class="prompt-header-section">
                            <div class="prompt-meta">
                                <div class="prompt-date">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${relativeTime}
                                </div>
                                <div class="prompt-usage ${prompt.usageCount > 0 ? 'used' : ''}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    Usado ${prompt.usageCount || 0} veces
                                </div>
                            </div>
                            <div class="prompt-actions">
                                <button class="prompt-action-btn copy" data-copy-id="${prompt.id}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copiar
                                </button>
                                <button class="prompt-action-btn delete" data-delete-id="${prompt.id}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Eliminar
                                </button>
                            </div>
                        </div>
                        
                        <div class="prompt-content-section">
                            ${formatPromptText(highlightedText)}
                        </div>
                        
                        <div class="prompt-footer">
                            ${tagsHtml}
                            <div class="prompt-badges">
                                ${similarityBadge}
                                ${semanticScore}
                            </div>
                        </div>
                    `;
                    
                    savedPromptsList.appendChild(card);
                });
            };

            const renderTagFilters = () => {
                const allTags = new Set();
                savedPrompts.forEach(prompt => {
                    if (prompt.tags) {
                        prompt.tags.forEach(tag => allTags.add(tag));
                    }
                });

                tagFilterList.innerHTML = '';
                if (allTags.size === 0) return;

                const allButton = document.createElement('button');
                allButton.textContent = 'Todos';
                allButton.className = `px-3 py-1 text-xs rounded-full border ${!activeTagFilter ? 'bg-blue-600 text-white border-blue-600' : 'bg-secondary text-secondary border-custom hover:bg-tertiary'} transition-colors`;
                allButton.addEventListener('click', () => filterByTag(null));
                tagFilterList.appendChild(allButton);

                allTags.forEach(tag => {
                    const button = document.createElement('button');
                    button.textContent = tag;
                    button.className = `px-3 py-1 text-xs rounded-full border ${activeTagFilter === tag ? 'bg-blue-600 text-white border-blue-600' : 'bg-secondary text-secondary border-custom hover:bg-tertiary'} transition-colors`;
                    button.addEventListener('click', () => filterByTag(tag));
                    tagFilterList.appendChild(button);
                });
            };
            
            const filterByTag = (tag) => {
                activeTagFilter = activeTagFilter === tag ? null : tag;
                renderTagFilters();
                applyAllFilters();
            };

            // Aplicar todos los filtros
            const applyAllFilters = () => {
                let promptsToFilter = [...savedPrompts];

                // Filtro por término de búsqueda
                if (searchFilters.searchTerm) {
                    promptsToFilter = promptsToFilter.filter(prompt => 
                        prompt.text.toLowerCase().includes(searchFilters.searchTerm.toLowerCase())
                    );
                }

                // Filtro por etiquetas
                if (searchFilters.tags.length > 0) {
                    promptsToFilter = promptsToFilter.filter(prompt => 
                        prompt.tags && searchFilters.tags.some(tag => prompt.tags.includes(tag))
                    );
                }

                // Filtro por etiqueta activa (sistema antiguo)
                if (activeTagFilter) {
                    promptsToFilter = promptsToFilter.filter(prompt => 
                        prompt.tags && prompt.tags.includes(activeTagFilter)
                    );
                }

                // Filtro por fecha
                if (searchFilters.dateFrom) {
                    const fromDate = new Date(searchFilters.dateFrom);
                    promptsToFilter = promptsToFilter.filter(prompt => 
                        new Date(prompt.timestamp) >= fromDate
                    );
                }

                if (searchFilters.dateTo) {
                    const toDate = new Date(searchFilters.dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    promptsToFilter = promptsToFilter.filter(prompt => 
                        new Date(prompt.timestamp) <= toDate
                    );
                }

                // Filtro por uso
                const now = new Date();
                switch (searchFilters.usage) {
                    case 'frequent':
                        promptsToFilter = promptsToFilter.filter(p => p.usageCount > 5);
                        break;
                    case 'recent':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        promptsToFilter = promptsToFilter.filter(p => 
                            p.lastUsed && new Date(p.lastUsed) >= weekAgo
                        );
                        break;
                    case 'never':
                        promptsToFilter = promptsToFilter.filter(p => p.usageCount === 0);
                        break;
                }

                // Filtro por calidad (simulado)
                if (searchFilters.quality !== 'all') {
                    promptsToFilter = promptsToFilter.filter(prompt => {
                        // Simular análisis de calidad basado en longitud y estructura
                        const textLength = prompt.text.length;
                        let estimatedScore = 50;
                        
                        if (textLength > 200) estimatedScore += 20;
                        if (prompt.text.includes('ROL')) estimatedScore += 15;
                        if (prompt.text.includes('CONTEXTO')) estimatedScore += 15;
                        
                        switch (searchFilters.quality) {
                            case 'excellent':
                                return estimatedScore >= 80;
                            case 'good':
                                return estimatedScore >= 60 && estimatedScore < 80;
                            case 'needs-improvement':
                                return estimatedScore < 60;
                        }
                    });
                }
                
                filteredPrompts = promptsToFilter;
                renderSavedPrompts(filteredPrompts);
                
                // Actualizar estadísticas
                if (searchFilters.searchTerm || searchFilters.tags.length > 0 || 
                    searchFilters.dateFrom || searchFilters.dateTo || 
                    searchFilters.usage !== 'all' || searchFilters.quality !== 'all') {
                    updateSearchStats(filteredPrompts.length, 'relevancia');
                } else {
                    searchStats.classList.add('hidden');
                }
            };

            const savePromptsToStorage = () => {
                localStorage.setItem('aiPromptGeneratorHistory', JSON.stringify(savedPrompts));
            };

            const loadPromptsFromStorage = () => {
                const stored = localStorage.getItem('aiPromptGeneratorHistory');
                if (stored) {
                    savedPrompts = JSON.parse(stored);
                }
                
                // Cargar búsquedas guardadas
                const savedSearchesStored = localStorage.getItem('savedSearches');
                if (savedSearchesStored) {
                    savedSearches = JSON.parse(savedSearchesStored);
                }
                
                renderTagFilters();
                applyAllFilters();
            };

            const applyTemplate = () => {
                const rolValue = rolInput.value.toLowerCase();
                let matchedKeyword = null;

                for (const keyword in templatesByKeyword) {
                    if (rolValue.includes(keyword)) {
                        matchedKeyword = keyword;
                        break;
                    }
                }

                if (matchedKeyword && templatesByKeyword[matchedKeyword]) {
                    if (!contextoInput.value && !tareaInput.value && !formatoInput.value && !restriccionesInput.value) {
                        const templateData = templatesByKeyword[matchedKeyword];
                        contextoInput.value = templateData.contexto;
                        tareaInput.value = templateData.tarea;
                        formatoInput.value = templateData.formato;
                        restriccionesInput.value = templateData.restricciones;
                        showFeedback(`Plantilla "${matchedKeyword}" aplicada.`, 'blue');
                    }
                }
            };
            
            // --- Event Listeners ---
            const debounce = (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            };

            const debouncedGenerate = debounce(generatePrompt, 500);

            rolInput.addEventListener('input', () => {
                applyTemplate();
                debouncedGenerate();
            });
            contextoInput.addEventListener('input', debouncedGenerate);
            tareaInput.addEventListener('input', debouncedGenerate);
            formatoInput.addEventListener('input', debouncedGenerate);
            restriccionesInput.addEventListener('input', debouncedGenerate);

            generateBtn.disabled = true;
            
            saveBtn.addEventListener('click', saveCurrentPrompt);
            copyBtn.addEventListener('click', () => copyToClipboard(outputPrompt.textContent));

            // Event listeners para búsqueda avanzada
            searchInput.addEventListener('input', debounce((e) => {
                searchFilters.searchTerm = e.target.value;
                applyAllFilters();
            }, 300));

            // Filtros de etiquetas
            function renderTagCheckboxes() {
                const container = document.getElementById('tagFilters');
                const allTags = new Set();
                
                savedPrompts.forEach(prompt => {
                    if (prompt.tags) {
                        prompt.tags.forEach(tag => allTags.add(tag));
                    }
                });

                container.innerHTML = '';
                
                // Botón "Todas"
                const allChip = document.createElement('span');
                allChip.className = 'filter-chip active';
                allChip.textContent = 'Todas';
                allChip.addEventListener('click', () => {
                    searchFilters.tags = [];
                    document.querySelectorAll('#tagFilters .filter-chip').forEach(chip => {
                        chip.classList.remove('active');
                    });
                    allChip.classList.add('active');
                    applyAllFilters();
                });
                container.appendChild(allChip);

                allTags.forEach(tag => {
                    const chip = document.createElement('span');
                    chip.className = 'filter-chip';
                    chip.textContent = tag;
                    chip.addEventListener('click', () => {
                        chip.classList.toggle('active');
                        
                        if (chip.classList.contains('active')) {
                            if (!searchFilters.tags.includes(tag)) {
                                searchFilters.tags.push(tag);
                            }
                        } else {
                            searchFilters.tags = searchFilters.tags.filter(t => t !== tag);
                        }
                        
                        applyAllFilters();
                    });
                    container.appendChild(chip);
                });
            }

            // Filtros de uso
            document.querySelectorAll('[data-usage]').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('[data-usage]').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    searchFilters.usage = chip.dataset.usage;
                    applyAllFilters();
                });
            });

            // Filtros de calidad
            document.querySelectorAll('[data-quality]').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('[data-quality]').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    searchFilters.quality = chip.dataset.quality;
                    applyAllFilters();
                });
            });

            // Filtros de fecha
            document.getElementById('dateFrom').addEventListener('change', (e) => {
                searchFilters.dateFrom = e.target.value;
                applyAllFilters();
            });

            document.getElementById('dateTo').addEventListener('change', (e) => {
                searchFilters.dateTo = e.target.value;
                applyAllFilters();
            });

            // Botón limpiar filtros
            document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                searchFilters = {
                    tags: [],
                    dateFrom: null,
                    dateTo: null,
                    usage: 'all',
                    quality: 'all',
                    searchTerm: '',
                    semanticQuery: '',
                    similarityThreshold: 50
                };
                
                searchInput.value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('semanticInput').value = '';
                document.getElementById('similarityInput').value = '';
                
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                document.querySelector('[data-usage="all"]').classList.add('active');
                document.querySelector('[data-quality="all"]').classList.add('active');
                
                applyAllFilters();
                showFeedback('Filtros limpiados', 'green');
            });

            savedPromptsList.addEventListener('click', (e) => {
                const copyButton = e.target.closest('.prompt-action-btn.copy');
                const deleteButton = e.target.closest('.prompt-action-btn.delete');

                if (copyButton) {
                    const promptId = Number(copyButton.dataset.copyId);
                    const promptToCopy = savedPrompts.find(p => p.id === promptId);
                    if (promptToCopy) {
                        copyToClipboard(promptToCopy.text);
                        // Actualizar contador de uso
                        promptToCopy.usageCount = (promptToCopy.usageCount || 0) + 1;
                        promptToCopy.lastUsed = new Date().toISOString();
                        savePromptsToStorage();
                        renderSavedPrompts(filteredPrompts);
                    }
                }

                if (deleteButton) {
                    const promptId = Number(deleteButton.dataset.deleteId);
                    deletePrompt(promptId);
                }
            });

            // Carga inicial
            renderTemplateMenu();
            loadPromptsFromStorage();
            renderTagCheckboxes();
        });
    </script>
</body>
</html>